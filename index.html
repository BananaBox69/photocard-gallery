<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Pop Photocard Treasures</title>
    
    <!-- Website Icon (Favicon) - Changed to Banana Emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçå</text></svg>">

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* --- START OF CSS --- */

        /* ------------------- */
        /* --- GLOBAL & THEME SETUP --- */
        /* ------------------- */
        :root {
            --font-main: 'Poppins', sans-serif;
            
            /* --- Bright Theme Colors --- */
            --color-bg: #f4f4f9;
            --color-surface: #ffffff;
            --color-text: #1a1a2e;
            --color-text-muted: #5a5a6e;
            --color-border: #1a1a2e;
            --shadow-color: #1a1a2e;
            --card-bg: #e9e9f3;

            --color-gold: #e6a200;
            --color-gold-dark: #b89b00;
            --color-success: #3a9a40;
            --color-error: #d93434;
            --color-info: #2196F3;
            --color-white: #ffffff;
            --color-heart: #ff4757;
            --color-purple: #9065db;

            /* Theming Variables */
            --theme-color-primary: #FF3B30;
            --theme-color-primary-dark: #c62828;
            --theme-color-primary-glow: rgba(255, 59, 48, 0.7);

            /* Card Sizing */
            --card-width: 200px;
            --card-aspect-ratio: 1 / 1.55; /* Define a consistent aspect ratio */
            --card-border-radius: 16px;
        }

        /* Member Themes */
        .theme-redvelvet { --theme-color-primary: #f53123; --theme-color-primary-dark: #c62828; --theme-color-primary-glow: rgba(245, 49, 35, 0.7); }
        .theme-irene { --theme-color-primary: #ff63b8; --theme-color-primary-dark: #c71585; --theme-color-primary-glow: rgba(255, 99, 184, 0.7); }
        .theme-seulgi { --theme-color-primary: #ff8800; --theme-color-primary-dark: #cc7000; --theme-color-primary-glow: rgba(255, 136, 0, 0.7); }
        .theme-wendy { --theme-color-primary: #188dff; --theme-color-primary-dark: #104e8b; --theme-color-primary-glow: rgba(24, 141, 255, 0.7); }
        .theme-joy { --theme-color-primary: #29c729; --theme-color-primary-dark: #228b22; --theme-color-primary-glow: rgba(41, 199, 41, 0.7); }
        .theme-yeri { --theme-color-primary: #9065db; --theme-color-primary-dark: #6a5acd; --theme-color-primary-glow: rgba(144, 101, 219, 0.7); }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-main);
            line-height: 1.6;
            transition: background-image 0.5s ease;
            overflow-x: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='150' height='150' viewBox='0 0 150 150' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='15' y='30' font-size='15' fill-opacity='0.3' fill='%23d8d8e3' text-anchor='middle'%3E%F0%9F%90%B0%3C/text%3E%3Ctext x='90' y='20' font-size='15' fill-opacity='0.3' fill='%23d8d8e3' text-anchor='middle'%3E%F0%9F%90%BB%3C/text%3E%3Ctext x='50' y='90' font-size='15' fill-opacity='0.3' fill='%23d8d8e3' text-anchor='middle'%3E%F0%9F%90%BB%3C/text%3E%3Ctext x='130' y='70' font-size='15' fill-opacity='0.3' fill='%23d8d8e3' text-anchor='middle'%3E%F0%9F%90%A4%3C/text%3E%3Ctext x='30' y='130' font-size='15' fill-opacity='0.3' fill='%23d8d8e3' text-anchor='middle'%3E%F0%9F%90%A2%3C/text%3E%3C/svg%3E");
        }
        
        /* Neobrutalism UI Style */
        .neo-ui {
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 16px;
            box-shadow: 4px 4px 0px var(--shadow-color);
            transition: box-shadow 0.2s ease, transform 0.2s ease, border-color 0.3s ease;
        }
        
        /* ------------------- */
        /* --- LAYOUT & MAIN UI --- */
        /* ------------------- */
        .main-header {
            padding: 2rem;
            text-align: center;
            background-color: var(--theme-color-primary);
            color: var(--color-white);
            border-bottom: 2px solid var(--color-border);
            transition: background-color 0.5s ease;
            background-image: radial-gradient(rgba(255, 255, 255, 0.2) 2px, transparent 2px);
            background-size: 8px 8px;
        }

        .main-header h1 {
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
        }
        
        .bias-title {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--color-white);
            text-shadow: 1px 1px 0px rgba(0,0,0,0.2);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .bias-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 0.5rem;
        }

        .bias-bubble {
            width: 44px; height: 44px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.3rem;
            color: var(--color-white);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid var(--color-border);
            box-shadow: 2px 2px 0px var(--color-border);
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 2px, transparent 2px, transparent 6px);
        }

        .bias-bubble:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0px var(--color-border);
        }

        .bias-bubble.active {
            transform: scale(1.1);
            background-color: var(--color-white) !important;
            box-shadow: 4px 4px 0px var(--theme-color-primary);
            color: var(--theme-color-primary) !important;
        }
        
        #bias-rv { background-color: #f53123; }
        #bias-irene { background-color: #ff63b8; }
        #bias-seulgi { background-color: #ff8800; }
        #bias-wendy { background-color: #188dff; }
        #bias-joy { background-color: #29c729; }
        #bias-yeri { background-color: #9065db; }
        
        .controls-wrapper {
            padding: 1rem 2rem;
            position: sticky; top: 0; z-index: 100;
            margin-bottom: 2rem;
            background-color: var(--color-bg);
            padding-top: 1.5rem; padding-bottom: 1.5rem;
        }

        .controls-bar {
            padding: 1rem 1.5rem;
            display: flex; flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: center; /* Reverted to center for desktop */
        }
        
        body[class*="theme-"] .controls-bar {
            --shadow-color: var(--theme-color-primary);
            border-color: var(--theme-color-primary);
        }
        
        body[class*="theme-"] .controls-bar select,
        body[class*="theme-"] .controls-bar .search-box input[type="text"] {
            border-color: var(--theme-color-primary);
            color: var(--theme-color-primary);
        }
        body[class*="theme-"] .controls-bar .search-box input[type="text"]::placeholder {
            color: var(--theme-color-primary);
            opacity: 0.7;
        }
        body[class*="theme-"] .controls-bar input[type="text"]:focus,
        body[class*="theme-"] .controls-bar select:focus {
            outline: none;
            border-color: var(--theme-color-primary);
            box-shadow: 0 0 0 2px var(--theme-color-primary);
        }
        body[class*="theme-"] .controls-bar .search-box i,
        body[class*="theme-"] .controls-bar .sort-group i {
            color: var(--theme-color-primary);
        }

        .search-box, .filter-group, .sort-group {
            display: flex; align-items: center;
            gap: 0.5rem;
            color: var(--color-text-muted);
        }

        /* Desktop Filter/Sort alignment - Reverted to original desktop widths */
        .controls-bar input[type="text"] { width: 220px; }
        .controls-bar select { min-width: 140px; }
        /* Revert justify-content for groups to default (flex-start if not explicitly set) */
        .controls-bar .search-box,
        .controls-bar .filter-group,
        .controls-bar .sort-group {
            justify-content: flex-start; /* Reverted */
        }


        input[type="text"], 
        input[type="email"], 
        input[type="password"], 
        input[type="url"], 
        input[type="number"], 
        select {
            background-color: var(--color-bg);
            color: var(--color-text);
            border: 2px solid var(--color-border);
            padding: 0.6rem 1rem;
            border-radius: 12px;
            font-family: var(--font-main);
            font-weight: 600;
            transition: all 0.2s ease;
            min-height: 48px;
            -webkit-appearance: none;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--theme-color-primary);
            box-shadow: 0 0 0 2px var(--theme-color-primary);
        }

        #card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(var(--card-width), 1fr));
            gap: 3rem 1.5rem;
            padding: 0 2rem 10rem 2rem;
            perspective: 1500px;
            justify-items: center; /* Center cards horizontally */
        }
        
        .loading-spinner {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: var(--theme-color-primary);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ------------------- */
        /* --- CARD STYLING --- */
        /* ------------------- */
        .card-container {
            width: var(--card-width); 
            /* Use padding-bottom for aspect ratio */
            padding-bottom: calc(var(--card-width) * 1.55 / 1); /* 1.55 is height/width ratio */
            position: relative;
            --member-shadow-color: var(--shadow-color);
            --member-shadow-rgb: 26, 26, 46; /* Default RGB */
        }

        .photocard {
            position: absolute; /* Position absolutely within the padded container */
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%; /* Fill the padded container */
            background-color: var(--card-bg);
            border-radius: var(--card-border-radius);
            overflow: hidden; cursor: pointer;
            display: flex; flex-direction: column;
            transform-style: preserve-3d;
            border: 2px solid var(--color-border);
            box-shadow: 4px 4px 0px var(--member-shadow-color);
            transition: all 0.2s ease-out;
            --mx: 0.5; --my: 0.5;
        }
        
        .photocard:hover {
            transform: translateY(-6px); /* Stronger lift */
            box-shadow: 12px 12px 0px var(--member-shadow-color); /* Stronger shadow */
        }
        
        .photocard .card-image {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover; z-index: 1;
            transition: transform 0.4s ease;
        }
        
        .photocard .card-border {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            border-radius: calc(var(--card-border-radius) - 2px);
            border: 4px solid transparent;
            z-index: 5; pointer-events: none;
            border-image-slice: 1;
        }
        
        .photocard::before {
            content: '';
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: linear-gradient(
                115deg, transparent 40%, rgba(255, 255, 255, 0.2) 50%, transparent 60%
            );
            background-size: 250% 250%;
            background-position: calc((var(--mx) - 0.5) * 180%) calc((var(--my) - 0.5) * 180%);
            z-index: 3; opacity: 0;
            mix-blend-mode: overlay;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        /* Stronger hover effect for all cards, including rare */
        .photocard:hover::before { opacity: 0.8; } 

        /* Rare card sheen animation (Desktop) */
        .photocard.rare::after {
            content: '';
            position: absolute;
            top: 0; /* Position at top of card */
            left: 0; /* Position at left of card */
            width: 100%; /* Cover the card width */
            height: 100%; /* Cover the card height */
            
            /* Diagonal linear gradient for the sweeping effect */
            background: linear-gradient(
                135deg, /* Angle for the sheen */
                transparent 0%,
                rgba(var(--member-shadow-rgb), 0.2) 30%, /* Use RGB for better blending */
                rgba(var(--member-shadow-rgb), 0.5) 50%,
                rgba(var(--member-shadow-rgb), 0.2) 70%,
                transparent 100%
            );
            background-size: 200% 100%; /* Make it wider than the card to allow sweeping */
            background-position: -100% 0; /* Start off-screen left */
            
            z-index: 4;
            mix-blend-mode: hard-light;
            opacity: 0.8; /* Keep it visible when auto-playing */
            pointer-events: none;
            animation: rare-sheen-wave 4s infinite linear; /* Auto-play animation with linear timing */
            /* Removed transform-origin as we are animating background-position */
        }

        .photocard.rare:hover::after {
            opacity: 0; /* Hide auto-sheen on hover to let tilt effect take over */
            animation-play-state: paused; /* Pause auto-play animation on hover */
        }

        @keyframes rare-sheen-wave {
            0% { background-position: -100% 0; } /* Start off-screen left */
            100% { background-position: 100% 0; } /* Move across to off-screen right */
        }


        .photocard.rare {
            --rare-glow-color: var(--member-shadow-color);
            animation: rare-glow 2.5s infinite ease-in-out;
        }
        @keyframes rare-glow {
            0%, 100% { filter: drop-shadow(0 0 8px var(--rare-glow-color)); }
            50% { filter: drop-shadow(0 0 20px var(--rare-glow-color)); }
        }
        
        .card-info {
            position: relative; z-index: 6;
            padding: 10px;
            background: linear-gradient(to top, rgba(26, 26, 46, 0.9) 20%, rgba(26, 26, 46, 0.7) 60%, transparent 100%);
            color: var(--color-white);
            transform: translateZ(20px);
            margin-top: auto;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-end; /* Align items to the bottom */
        }

        .card-info .card-text {
            flex-grow: 1;
            display: flex; /* Use flexbox for inner alignment */
            flex-direction: column;
            justify-content: flex-end; /* Push content to the bottom */
            padding-bottom: 2px; /* Small adjustment for visual alignment */
            /* Default state for desktop - visible */
            height: auto;
            overflow: visible;
            opacity: 1;
            transition: none; /* No transition on desktop by default */
        }

        .card-info .member { font-weight: 600; font-size: 0.9rem; }
        .card-info .album { 
            font-size: 0.75rem; 
            color: #c0c0d0; 
            min-height: auto; /* Remove min-height to allow natural content height */
            line-height: 1.2rem;
        }
        .card-info .price {
            font-weight: 700; font-size: 1.2rem;
            color: var(--color-gold); /* Default price color */
            text-shadow: 0px 1px 3px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; align-items: flex-end;
            text-align: right;
            white-space: nowrap;
        }
        /* New styles for discounted prices */
        .card-info .price.price-sale {
            color: var(--color-error); /* Matches tag-sale color */
        }
        .card-info .price.price-super-sale {
            color: var(--color-purple); /* Matches tag-super-sale color */
        }

        .card-info .price .original-price { text-decoration: line-through; font-size: 0.8rem; color: #c0c0d0; }
        
        .card-id {
            position: absolute; top: 8px; left: 8px; z-index: 7;
            background-color: rgba(0,0,0,0.6); color: #ccc;
            padding: 2px 6px; border-radius: 8px;
            font-size: 0.7rem; font-weight: bold;
        }
        
        .card-tags {
            position: absolute; top: 8px; right: 8px; z-index: 7;
            display: flex; flex-direction: column; gap: 4px; align-items: flex-end;
        }

        .tag {
            background-color: var(--theme-color-primary); color: white;
            padding: 3px 10px; border-radius: 8px;
            font-size: 0.7rem; font-weight: bold;
            border: 1px solid var(--color-border);
        }
        .tag.tag-new { background-color: var(--color-info); --glow-color: var(--color-info); animation: tag-glow 2.5s infinite ease-in-out; }
        .tag.tag-sale { background-color: var(--color-error); --glow-color: var(--color-error); animation: tag-glow 2.5s infinite ease-in-out; }
        .tag.tag-super-sale { background-color: var(--color-purple); --glow-color: var(--color-purple); animation: tag-glow 2.5s infinite ease-in-out; }
        .tag.tag-rare { background-color: var(--color-gold); color: var(--color-border); --glow-color: var(--color-gold); animation: tag-glow 2.5s infinite ease-in-out; }
        
        @keyframes tag-glow {
            0%, 100% { box-shadow: 0 0 3px var(--glow-color); }
            50% { box-shadow: 0 0 8px var(--glow-color); }
        }

        .selected-indicator {
            position: absolute; /* Kept absolute to position freely */
            right: 10px; /* Aligned to the right */
            z-index: 8;
            font-size: 1.8rem; color: var(--color-heart);
            text-shadow: 0 0 8px rgba(0,0,0,0.8);
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* New positioning for above price */
            bottom: calc(10px + var(--price-height, 0px)); /* Adjust based on price height */
        }

        .photocard.selected {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 0 0 3px var(--theme-color-primary), 8px 8px 0px var(--theme-color-primary);
        }
        .photocard.selected .selected-indicator { transform: scale(1); }

        .status-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 9;
            display: flex; align-items: center; justify-content: center;
            color: var(--color-border);
            font-family: var(--font-main); font-weight: 800;
            font-size: 2rem; text-transform: uppercase; letter-spacing: 2px;
            pointer-events: none; opacity: 0; transition: opacity 0.3s ease;
        }
        
        .photocard.reserved { cursor: not-allowed; filter: grayscale(25%); }
        .photocard.sold { cursor: not-allowed; filter: grayscale(100%); }
        .photocard.reserved .status-overlay { background-color: rgba(255,255,255,0.4); }
        .photocard.sold .status-overlay { background-color: rgba(255,255,255,0.7); }
        .photocard.sold .status-overlay, .photocard.reserved .status-overlay { opacity: 1; }
        
        /* ------------------- */
        /* --- FLOATING UI & MODALS --- */
        /* ------------------- */

        .floating-bar {
            position: fixed; bottom: 1rem; left: 50%;
            width: calc(100% - 4rem); max-width: 800px;
            padding: 1rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            transform: translate(-50%, 200%);
            transition: transform 0.4s ease, border-color 0.5s ease;
            border-top: 2px solid var(--color-border) !important;
        }
        .floating-bar.visible { transform: translate(-50%, 0); }
        .floating-bar .selection-info { font-weight: 600; }
        .floating-bar .actions { display: flex; gap: 1rem; }
        
        .btn {
            background-color: var(--theme-color-primary); color: var(--color-white);
            border: 2px solid var(--color-border);
            padding: 0.7rem 1.4rem; border-radius: 12px;
            cursor: pointer; font-weight: 700;
            transition: all 0.2s ease;
            box-shadow: 4px 4px 0px var(--shadow-color);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px var(--shadow-color);
        }
        .btn:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 2px 2px 0px var(--shadow-color);
        }
        .btn-secondary { background-color: var(--color-surface); color: var(--color-text); }

        .floating-buttons {
            position: fixed; bottom: 20px; right: 20px; z-index: 101;
            display: flex; flex-direction: column; gap: 1rem;
        }

        .float-btn {
            width: 50px; height: 50px; border-radius: 50%;
            color: var(--color-text);
            border: 2px solid var(--color-border);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer;
            transition: all 0.2s ease;
        }
        .float-btn:hover {
            transform: scale(1.1) rotate(15deg);
            background-color: var(--theme-color-primary);
            color: var(--color-white);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(26, 26, 46, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }

        .modal {
            padding: 2rem; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal { transform: scale(1) translateY(0); }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem;
            border-bottom: 2px solid var(--color-border);
        }
        .modal-header h2 { color: var(--theme-color-primary); font-size: 2rem; font-weight: 800; }
        .close-modal {
            background: none; border: none; color: var(--color-text-muted);
            font-size: 2rem; cursor: pointer; transition: color 0.2s, transform 0.2s;
        }
        .close-modal:hover { color: var(--color-text); transform: rotate(90deg); }
        
        .modal-content h3 { color: var(--color-gold); margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .modal-content p, .modal-content li { color: var(--color-text-muted); margin-bottom: 0.5rem; }
        .modal-content ul { padding-left: 20px; }
        .modal-content a { color: var(--theme-color-primary); text-decoration: none; font-weight: bold; }
        .modal-content a:hover { text-decoration: underline; }
        
        #generated-message {
            width: 100%; height: 200px;
            background-color: var(--color-bg); color: var(--color-text);
            border: 2px solid var(--color-border); border-radius: 12px;
            padding: 1rem; margin-top: 1rem; resize: vertical;
        }
        
        /* ------------------- */
        /* --- ADMIN MODE & FORMS --- */
        /* ------------------- */
        .admin-controls {
            display: none; padding: 1rem 2rem;
            background: rgba(217, 52, 52, 0.1);
            border-bottom: 2px solid var(--color-error);
        }
        body.admin-mode .admin-controls { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        
        .bulk-actions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .bulk-btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .admin-card-controls {
            display: none; position: absolute; bottom: 0; left: 0;
            width: 100%;
            background: linear-gradient(to top, rgba(26, 26, 46, 0.9) 20%, transparent 100%);
            z-index: 8; padding: 8px; justify-content: space-around;
            border-bottom-left-radius: calc(var(--card-border-radius) - 2px);
            border-bottom-right-radius: calc(var(--card-border-radius) - 2px);
        }
        body.admin-mode .photocard:hover .admin-card-controls { display: flex; }
        
        .admin-card-controls button {
            background: none; border: none; color: white;
            cursor: pointer; font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .admin-card-controls button:hover { background-color: var(--theme-color-primary); }
        
        .form-group { margin-bottom: 1rem; position: relative; }
        #admin-form label, .checkout-form label, #login-form label, #filters-modal label {
            display: block; margin-bottom: 0.5rem;
            font-weight: 600; font-size: 0.9rem;
            color: var(--color-text-muted);
        }
        #admin-form input, #admin-form select, .checkout-form input, .checkout-form select, #login-form input, #login-form select, #filters-modal input, #filters-modal select { width: 100%; }
        #admin-form input[type="checkbox"] { width: auto; }
        #card-id[readonly] { background-color: var(--color-bg); cursor: not-allowed; }
        
        #admin-form #card-price { max-width: 150px; }
        
        #admin-form .form-buttons, #filters-modal .form-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .autocomplete-suggestions {
            position: absolute; top: 100%; left: 0; right: 0;
            max-height: 150px; overflow-y: auto;
            z-index: 1001; margin-top: 4px;
        }
        .autocomplete-suggestion { padding: 10px; cursor: pointer; }
        .autocomplete-suggestion:hover, .autocomplete-suggestion.selected {
            background: var(--theme-color-primary); color: white;
        }

        #login-error {
            color: var(--color-error);
            margin-top: 1rem;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        /* ------------------- */
        /* --- RESPONSIVE DESIGN --- */
        /* ------------------- */
        @media (max-width: 768px) {
            .main-header h1 { font-size: 2.5rem; }
            /* Hide the main controls bar on smaller screens */
            .controls-wrapper { display: none; } 
            
            /* Make modals full width on mobile */
            .modal {
                width: calc(100% - 2rem); /* Full width with padding */
                margin: 1rem; /* Add some margin around the modal */
            }
            .floating-bar { width: calc(100% - 2rem); }
            .floating-buttons { right: 10px; bottom: 10px; gap: 0.8rem; }
            .float-btn { width: 45px; height: 45px; font-size: 1.3rem; }

            /* Mobile Filter Modal specific styling */
            #filters-modal .modal-content {
                flex-direction: column; /* Keep as column for overall layout */
                gap: 1rem;
            }
            #filters-modal .form-group {
                display: grid; /* Use grid for consistent alignment */
                grid-template-columns: 1fr 220px; /* Label takes available space, input/select fixed to 220px */
                gap: 1rem; /* Space between label and input/select */
                align-items: center;
            }
            #filters-modal .form-group label {
                text-align: left; /* Ensure labels are left-aligned */
                margin-bottom: 0; /* Remove default margin-bottom */
            }
            #filters-modal .form-group select,
            #filters-modal .form-group input[type="text"] {
                width: 100%; /* Fill the grid column (220px) */
                justify-self: end; /* Align to the right of its grid cell */
                min-width: unset; /* Override previous min-width */
                margin: 0; /* Remove any lingering margins */
            }
            #filters-modal .form-group .search-box label { /* Specific adjustment for search icon */
                margin-right: 0; /* Reset margin */
            }


            /* Mobile text hiding/revealing */
            .card-info .card-text {
                max-height: 0; /* Start at 0 max-height */
                overflow: hidden; /* Hide overflow during transition */
                opacity: 0;
                padding-top: 0; /* Ensure padding is 0 when hidden */
                padding-bottom: 0; /* Ensure padding is 0 when hidden */
                transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            }

            .photocard[data-mobile-text-hidden="false"] .card-text {
                max-height: 999px; /* Use a large fixed height for full expansion */
                padding-top: 10px; /* Restore original padding */
                padding-bottom: 10px;
                opacity: 1;
            }

            /* Ensure the album text has a minimum height to prevent collapse */
            .photocard .card-info .album {
                min-height: 0; /* Resetting this for mobile */
            }

            /* NEW: Mobile Rare Card Glitter Effect - Bling Bling! */
            .photocard.rare::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                /* Multiple radial gradients for scattered sparkles */
                background:
                    radial-gradient(circle at 15% 25%, rgba(var(--member-shadow-rgb), 0.7) 1px, transparent 1.5px),
                    radial-gradient(circle at 85% 75%, rgba(var(--member-shadow-rgb), 0.7) 1px, transparent 1.5px),
                    radial-gradient(circle at 40% 60%, rgba(var(--member-shadow-rgb), 0.7) 1px, transparent 1.5px),
                    radial-gradient(circle at 60% 30%, rgba(var(--member-shadow-rgb), 0.7) 1px, transparent 1.5px),
                    radial-gradient(circle at 25% 90%, rgba(var(--member-shadow-rgb), 0.7) 1px, transparent 1.5px),
                    radial-gradient(circle at 75% 10%, rgba(var(--member-shadow-rgb), 0.7) 1px, transparent 1.5px);
                background-size: 20px 20px; /* Size of the repeating pattern */
                background-repeat: repeat;
                z-index: 4;
                mix-blend-mode: screen; /* Good for light effects over images */
                opacity: 0.4; /* Base opacity reduced to 0.4 */
                pointer-events: none;
                animation: glitter-move 8s infinite linear, glitter-pulse 1.5s infinite alternate ease-in-out;
            }

            @keyframes glitter-move {
                0% { background-position: 0% 0%; }
                100% { background-position: 100% 100%; }
            }

            @keyframes glitter-pulse {
                0%, 100% { opacity: 0.4; transform: scale(1); } /* Adjusted opacity to 0.4 */
                50% { opacity: 0.5; transform: scale(1.03); }  /* Adjusted opacity to 0.5 */
            }

            /* Re-enable the rare-glow animation for mobile */
            .photocard.rare {
                animation: rare-glow 2.5s infinite ease-in-out; /* Re-enable the pulsing glow */
            }

            /* Remove the old mobile-highlight class and its animation if the new sheen replaces it */
            .photocard.rare.mobile-highlight { /* This class is no longer needed in JS */
                animation: none;
            }
            /* Remove the mobile-rare-glow keyframes entirely */
            @keyframes mobile-rare-glow {
                /* No longer needed */
            }
        }

        @media (min-width: 769px) {
            /* Hide the filter toggle button on desktop */
            #filter-toggle-btn {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .main-header h1 { font-size: 2rem; }
            .bias-title { font-size: 1rem; }
            .bias-bubble { width: 40px; height: 40px; font-size: 1.1rem; }
            /* Two cards per row, centered, matching header width */
            #card-grid { 
                grid-template-columns: repeat(2, 1fr); /* Explicitly 2 columns */
                /* Calculate card width based on header content width (100vw - 4rem padding) */
                width: calc(100vw - 4rem); /* Match header content width (2rem padding on each side) */
                margin: 3rem auto 0 auto; /* Center the grid itself, add top margin */
                gap: 1rem; /* Increased gap between cards */
                padding: 0 0 10rem 0; /* Remove horizontal padding from grid, keep bottom */
            }
            /* Ensure card-container matches the calculated width */
            .card-container {
                width: 100%; /* Will be sized by grid 1fr */
            }


            .floating-bar .selection-info { font-size: 0.9rem; }
            .floating-bar .actions { gap: 0.5rem; }
            .btn { padding: 0.6rem 1rem; font-size: 0.9rem; }
            .bulk-actions-container { justify-content: center; }

            /* Filters modal specific adjustments for very small screens */
            #filters-modal .modal .modal-content {
                flex-direction: column;
                gap: 1rem;
            }
            #filters-modal .modal .modal-content .search-box,
            #filters-modal .modal .modal-content .filter-group,
            #filters-modal .modal .modal-content .sort-group {
                width: 100%;
                justify-content: flex-start; /* Align elements to start */
            }
        }
        
        /* --- END OF CSS --- */
    </style>
</head>

<body class="theme-redvelvet">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner">
        <i class="fa-solid fa-spinner fa-spin"></i>
    </div>

    <!-- Header -->
    <header class="main-header">
        <h1>Photocard Treasures</h1>
        <h3 class="bias-title">Choose your Bias!</h3>
        <div class="bias-selector">
            <div id="bias-rv" class="bias-bubble active" data-theme="redvelvet" title="Red Velvet">RV</div>
            <div id="bias-irene" class="bias-bubble" data-theme="irene" title="Irene">I</div>
            <div id="bias-seulgi" class="bias-bubble" data-theme="seulgi" title="Seulgi">S</div>
            <div id="bias-wendy" class="bias-bubble" data-theme="wendy" title="Wendy">W</div>
            <div id="bias-joy" class="bias-bubble" data-theme="joy" title="Joy">J</div>
            <div id="bias-yeri" class="bias-bubble" data-theme="yeri" title="Yeri">Y</div>
        </div>
    </header>

    <!-- Admin Controls -->
    <div id="admin-controls" class="admin-controls">
        <button id="add-card-btn" class="btn"><i class="fa-solid fa-plus"></i> Add New Card</button>
        <div id="bulk-actions-container" class="bulk-actions-container">
            <button class="btn btn-secondary bulk-btn" data-action="set-available"><i class="fa-solid fa-check"></i> Available</button>
            <button class="btn btn-secondary bulk-btn" data-action="set-reserved"><i class="fa-solid fa-lock"></i> Reserved</button>
            <button class="btn btn-secondary bulk-btn" data-action="set-sold"><i class="fa-solid fa-tag"></i> Sold</button>
            <button class="btn btn-secondary bulk-btn" data-action="toggle-rare"><i class="fa-solid fa-star"></i> Rare</button>
            <button class="btn btn-secondary bulk-btn" data-action="discount-10"><i class="fa-solid fa-percent"></i> 10%</button>
            <button class="btn btn-secondary bulk-btn" data-action="discount-20"><i class="fa-solid fa-percent"></i> 20%</button>
            <button class="btn btn-secondary bulk-btn" data-action="discount-0"><i class="fa-solid fa-xmark"></i> No Sale</button>
            <button class="btn btn-secondary bulk-btn" data-action="delete" style="background-color: var(--color-error); color: white;"><i class="fa-solid fa-trash"></i> Delete</button>
        </div>
        <button id="logout-btn" class="btn"><i class="fa-solid fa-right-from-bracket"></i> Log Out</button>
    </div>
    
    <!-- Controls Bar (Desktop Only) -->
    <div class="controls-wrapper">
        <div class="controls-bar neo-ui">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="search-input-desktop" placeholder="Search member, album...">
            </div>
            <div class="filter-group">
                <select id="group-filter-desktop">
                    <option value="all">All Groups</option>
                    <option value="Red Velvet">Red Velvet</option>
                    <option value="IU">IU</option>
                    <option value="aespa">aespa</option>
                </select>
                <select id="member-filter-desktop">
                    <option value="all">All Members</option>
                </select>
                <select id="status-filter-desktop">
                    <option value="available">Available Only</option>
                    <option value="all">All Statuses</option>
                    <option value="reserved">Reserved</option>
                    <option value="sold" id="status-filter-sold-desktop">Sold</option>
                </select>
            </div>
            <div class="sort-group">
                <i class="fa-solid fa-arrow-down-wide-short"></i>
                <select id="sort-by-desktop">
                    <option value="default">Default</option>
                    <option value="date-desc">Newest</option>
                    <option value="price-asc">Price: Low to High</option>
                    <option value="price-desc">Price: High to Low</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Card Grid -->
    <main id="card-grid"></main>

    <!-- Floating Bar for Selected Cards -->
    <div id="floating-bar" class="floating-bar neo-ui">
        <div id="selection-info" class="selection-info"></div>
        <div class="actions">
            <button id="unselect-all-btn" class="btn btn-secondary">Unselect All</button>
            <button id="checkout-btn" class="btn"><i class="fa-solid fa-cart-shopping"></i> Checkout</button>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-buttons">
        <button id="info-btn" class="float-btn neo-ui" title="Sale Info"><i class="fa-solid fa-circle-info"></i></button>
        <button id="admin-toggle-btn" class="float-btn neo-ui" title="Toggle Admin Mode"><i class="fa-solid fa-user-shield"></i></button>
        <button id="filter-toggle-btn" class="float-btn neo-ui" title="Filters"><i class="fa-solid fa-sliders"></i></button> <!-- New filter button -->
        <button id="back-to-top" class="float-btn neo-ui" title="Back to Top"><i class="fa-solid fa-arrow-up"></i></button>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="modal-overlay">
        <div class="modal neo-ui">
            <div class="modal-header">
                <h2>Selling Process Info</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-content">
                <h3>How to Buy:</h3>
                <ul>
                    <li>Browse the available photocards.</li>
                    <li>Select the cards you'd like to purchase by clicking on them (a <i class="fa-solid fa-heart" style="color:var(--color-heart);"></i> will appear).</li>
                    <li>Click the shopping cart icon at the bottom right to open the checkout summary.</li>
                    <li>Fill in your shipping and payment preferences.</li>
                    <li>Click "Copy Message" and send the generated text to me on Instagram!</li>
                </ul>
                <h3>Payment Methods:</h3>
                <ul>
                    <li>PayPal F&F (Friends & Family) - <strong>preferred</strong></li>
                    <li>Wise (formerly TransferWise)</li>
                    <li>Bank Transfer (within EU)</li>
                </ul>
                <h3>Shipping Information:</h3>
                <ul>
                    <li>Shipping costs are not included in the listed prices and will be calculated based on your location and chosen shipping method.</li>
                    <li>Options: Cheapest (untracked), Tracked, Insured.</li>
                    <li>I ship worldwide from Germany!</li>
                </ul>
                <h3>Condition:</h3>
                <p>All cards are sleeved and stored carefully in a dry, pet-free, and smoke-free household. While I strive for perfection, please note that some cards may have minor manufacturing defects or small imperfections. If you are highly sensitive to such details, I recommend refraining from purchasing.</p>
                <h3>Contact:</h3>
                <p>For any questions or to finalize a purchase, please message me on <a href="https://www.instagram.com/bananatrades877/" target="_blank" rel="noopener noreferrer">Instagram: @bananatrades877</a></p>
            </div>
        </div>
    </div>
    
    <!-- Checkout Modal -->
    <div id="checkout-modal" class="modal-overlay">
        <div class="modal neo-ui">
            <div class="modal-header">
                <h2>Your Selection</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-content checkout-form">
                <p>Please review your selection below. Fill in the form and then click "Copy Message" to prepare your order. Paste this message and send it to me on Instagram!</p>
                <div class="form-group">
                    <label for="shipping-country">Ship to (Country):</label>
                    <input type="text" id="shipping-country" placeholder="e.g., Germany, USA, Japan">
                </div>
                <div class="form-group">
                    <label for="shipping-method">Shipping Method:</label>
                    <select id="shipping-method">
                        <option>Cheapest</option>
                        <option>Tracked</option>
                        <option>Insured</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-method">Payment Method:</label>
                    <select id="payment-method">
                        <option>PayPal F&F</option>
                        <option>Wise</option>
                        <option>Bank Transfer (EU)</option>
                    </select>
                </div>
                <textarea id="generated-message" readonly></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                    <a href="https://www.instagram.com/bananatrades877/" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">
                        <i class="fa-brands fa-instagram"></i> Open Instagram
                    </a>
                    <button id="copy-message-btn" class="btn">Copy Message</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Form Modal (Add/Edit Card) -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal neo-ui">
            <div class="modal-header">
                <h2 id="admin-modal-title">Add New Card</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="admin-form" class="modal-content">
                <input type="hidden" id="card-doc-id">
                <div class="form-group">
                    <label for="card-group">Group</label>
                    <input type="text" id="card-group" autocomplete="off" required>
                </div>
                    <div class="form-group">
                    <label for="card-member">Member</label>
                    <input type="text" id="card-member" autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label for="card-id">Card ID (Auto-generated)</label>
                    <input type="text" id="card-id" readonly required>
                </div>
                    <div class="form-group">
                    <label for="card-album">Album / Origin</label>
                    <input type="text" id="card-album" autocomplete="off" required>
                </div>
                    <div class="form-group">
                    <label for="card-version">Version / Description</label>
                    <input type="text" id="card-version" autocomplete="off" required>
                </div>
                    <div class="form-group">
                    <label for="card-image-url">Image URL</label>
                    <input type="url" id="card-image-url" required>
                </div>
                    <div class="form-group">
                    <label for="card-price">Price (‚Ç¨)</label>
                    <input type="number" id="card-price" step="0.5" min="1" required>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="card-is-rare" style="width: auto;">
                    <label for="card-is-rare" style="margin-bottom: 0;">Is this a Rare card?</label>
                </div>
                <div class="form-buttons">
                    <button type="submit" id="save-card-btn" class="btn">Save Card</button>
                    <button type="button" id="save-and-add-next-btn" class="btn btn-secondary">Save & Add Next</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal neo-ui">
            <div class="modal-header">
                <h2>Admin Login</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="login-form" class="modal-content">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn">Log In</button>
                <p id="login-error"></p>
            </form>
        </div>
    </div>

    <!-- NEW: Filters Modal (for Mobile) -->
    <div id="filters-modal" class="modal-overlay">
        <div class="modal neo-ui">
            <div class="modal-header">
                <h2>Filters & Sorting</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-content">
                <div class="form-group search-box">
                    <label for="search-input-mobile"><i class="fa-solid fa-magnifying-glass"></i> Search</label>
                    <input type="text" id="search-input-mobile" placeholder="Search member, album...">
                </div>
                <div class="form-group filter-group">
                    <label for="group-filter-mobile">Group</label>
                    <select id="group-filter-mobile">
                        <option value="all">All Groups</option>
                        <option value="Red Velvet">Red Velvet</option>
                        <option value="IU">IU</option>
                        <option value="aespa">aespa</option>
                    </select>
                </div>
                <div class="form-group filter-group">
                    <label for="member-filter-mobile">Member</label>
                    <select id="member-filter-mobile">
                        <option value="all">All Members</option>
                    </select>
                </div>
                <div class="form-group filter-group">
                    <label for="status-filter-mobile">Status</label>
                    <select id="status-filter-mobile">
                        <option value="available">Available Only</option>
                        <option value="all">All Statuses</option>
                        <option value="reserved">Reserved</option>
                        <option value="sold" id="status-filter-sold-mobile">Sold</option>
                    </select>
                </div>
                <div class="form-group sort-group">
                    <label for="sort-by-mobile"><i class="fa-solid fa-arrow-down-wide-short"></i> Sort By</label>
                    <select id="sort-by-mobile">
                        <option value="default">Default</option>
                        <option value="date-desc">Newest</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                    </select>
                </div>
                <div class="form-buttons">
                    <button id="apply-filters-btn" class="btn">Apply Filters</button>
                    <button id="reset-filters-btn" class="btn btn-secondary">Reset Filters</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // --- START OF JAVASCRIPT ---
        
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, addDoc, deleteDoc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBWiXIpRVNIR18PzuRU67XTjGgn-tBjzeE",
            authDomain: "k-pop-price-list-super-pro.firebaseapp.com",
            projectId: "k-pop-price-list-super-pro",
            storageBucket: "k-pop-price-list-super-pro.firebaseestorage.app",
            messagingSenderId: "638515162354",
            appId: "1:638515162354:web:53e19e2f5efe920899f46b"
        };
        // -----------------------------------------

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE & CONSTANTS ---
        let allCards = [];
        let selectedCards = new Set();
        let isAdmin = false;
        let currentBias = 'redvelvet';
        const cardGrid = document.getElementById('card-grid');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        const MEMBER_COLORS = {
            'Irene': { start: '#FFC0CB', end: '#ff63b8', rgb: '255, 99, 184' },
            'Seulgi': { start: '#FFD700', end: '#ff8800', rgb: '255, 136, 0' },
            'Wendy': { start: '#ADD8E6', end: '#188dff', rgb: '24, 141, 255' },
            'Joy': { start: '#90EE90', end: '#29c729', rgb: '41, 199, 41' },
            'Yeri': { start: '#DDA0DD', end: '#9065db', rgb: '144, 101, 219' },
            'Karina': { start: '#87CEEB', end: '#4682B4', rgb: '70, 130, 180' },
            'Giselle': { start: '#FFFFFF', end: '#A9A9A9', rgb: '169, 169, 169' },
            'Winter': { start: '#B0E0E6', end: '#00BFFF', rgb: '0, 191, 255' },
            'Ningning': { start: '#FFB6C1', end: '#DC143C', rgb: '220, 20, 60' },
            'IU': { start: '#D8BFD8', end: '#8A2BE2', rgb: '138, 43, 226' },
        };

        let METADATA = {}; // Will be populated from Firestore

        // --- DOM ELEMENTS ---
        // Desktop controls
        const searchInputDesktop = document.getElementById('search-input-desktop');
        const groupFilterDesktop = document.getElementById('group-filter-desktop');
        const memberFilterDesktop = document.getElementById('member-filter-desktop');
        const statusFilterDesktop = document.getElementById('status-filter-desktop');
        const sortByDesktop = document.getElementById('sort-by-desktop');

        // Mobile controls (inside modal)
        const searchInputMobile = document.getElementById('search-input-mobile');
        const groupFilterMobile = document.getElementById('group-filter-mobile');
        const memberFilterMobile = document.getElementById('member-filter-mobile');
        const statusFilterMobile = document.getElementById('status-filter-mobile');
        const sortByMobile = document.getElementById('sort-by-mobile');

        const floatingBar = document.getElementById('floating-bar');
        const selectionInfo = document.getElementById('selection-info');

        // --- CORE FUNCTIONS ---

        async function fetchMetadata() {
            try {
                const metadataRef = collection(db, "metadata");
                const querySnapshot = await getDocs(metadataRef);
                METADATA.groups = [];
                querySnapshot.forEach(doc => {
                    METADATA[doc.id] = doc.data();
                    METADATA.groups.push(doc.id.replace(/([A-Z])/g, ' $1').trim()); // Format for display
                });
            } catch (error) {
                console.error("Error fetching metadata: ", error);
            }
        }

        async function fetchAndRenderCards() {
            loadingSpinner.style.display = 'block';
            cardGrid.innerHTML = '';
            
            try {
                const cardsRef = collection(db, "cards");
                const querySnapshot = await getDocs(cardsRef);
                
                allCards = querySnapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                
                populateMemberFilters(); // Populate both desktop and mobile member filters
                applyFiltersAndSort();
                
            } catch (error) {
                console.error("Error fetching cards: ", error);
                cardGrid.innerHTML = '<p style="color: var(--color-error); grid-column: 1 / -1; text-align: center;">Could not load card data. Please check console for errors.</p>';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function renderCards(cardsToRender) {
            cardGrid.innerHTML = '';
            if (cardsToRender.length === 0) {
                cardGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--color-text-muted);">No cards match the current filters. ‚ú®</p>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            cardsToRender.forEach(card => {
                const cardContainer = createCardElement(card);
                fragment.appendChild(cardContainer);
            });
            cardGrid.appendChild(fragment);

            // NEW: Measure price height and set CSS variable for selected-indicator positioning
            cardsToRender.forEach(cardData => {
                const cardElement = cardGrid.querySelector(`.photocard[data-doc-id="${cardData.docId}"]`);
                if (cardElement) {
                    const priceElement = cardElement.querySelector('.price');
                    if (priceElement) {
                        // Use requestAnimationFrame to ensure layout is updated before measurement
                        requestAnimationFrame(() => {
                            const priceHeight = priceElement.offsetHeight;
                            cardElement.style.setProperty('--price-height', `${priceHeight}px`);
                        });
                    }
                }
            });

            const cards = document.querySelectorAll(".photocard");
            if (window.VanillaTilt) {
                    VanillaTilt.init(cards, {
                        max: 8, speed: 400, glare: false, perspective: 1000
                    });
            }
            
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    card.style.setProperty('--mx', x / rect.width);
                    card.style.setProperty('--my', y / rect.height);
                });
                card.addEventListener('mouseleave', () => {
                    card.style.setProperty('--mx', 0.5);
                    card.style.setProperty('--my', 0.5);
                });
            });
        }
        
        function createCardElement(card) {
            const container = document.createElement('div');
            container.className = 'card-container';
            container.dataset.docId = card.docId;
            
            const memberColor = MEMBER_COLORS[card.member] || { start: 'var(--shadow-color)', end: 'var(--shadow-color)', rgb: '26, 26, 46' };
            container.style.setProperty('--member-shadow-color', memberColor.end);
            container.style.setProperty('--member-shadow-rgb', memberColor.rgb); // Set RGB for sheen animation
            container.style.setProperty('--rare-glow-color', memberColor.end);

            const isSelected = selectedCards.has(card.docId);
            const cardClasses = ['photocard'];
            if (isSelected) cardClasses.push('selected');
            if (card.status !== 'available') cardClasses.push(card.status);
            if (card.isRare) cardClasses.push('rare');

            const finalPrice = calculateDiscountedPrice(card.price, card.discount);
            const hasDiscount = finalPrice < card.price;

            const dateAdded = card.dateAdded?.toDate ? card.dateAdded.toDate() : new Date();
            const timeDiff = new Date() - dateAdded;
            const isNew = timeDiff < 7 * 24 * 60 * 60 * 1000;

            let displayedTagHtml = '';
            // Determine if it's a mobile view
            const isMobileView = window.innerWidth <= 768;

            if (isMobileView) { // Only for mobile: show one tag based on priority
                if (isNew) {
                    displayedTagHtml = '<span class="tag tag-new">NEW</span>';
                } else if (card.discount === 20) {
                    displayedTagHtml = '<span class="tag tag-super-sale">SUPER SALE</span>';
                } else if (card.discount === 10) {
                    displayedTagHtml = '<span class="tag tag-sale">SALE</span>';
                } else if (card.isRare) {
                    displayedTagHtml = `<span class="tag tag-rare">RARE</span>`; // Removed mobile-highlight class
                }
            } else { // Desktop: show all relevant tags
                if (isNew) displayedTagHtml += '<span class="tag tag-new">NEW</span>';
                if (card.isRare) displayedTagHtml += '<span class="tag tag-rare">RARE</span>';
                if (card.discount === 10) displayedTagHtml += '<span class="tag tag-sale">SALE</span>';
                if (card.discount === 20) displayedTagHtml += '<span class="tag tag-super-sale">SUPER SALE</span>';
            }

            // Determine price color class
            let priceColorClass = '';
            if (card.discount === 10) {
                priceColorClass = 'price-sale';
            } else if (card.discount === 20) {
                priceColorClass = 'price-super-sale';
            }


            container.innerHTML = `
                <div class="${cardClasses.join(' ')}" data-doc-id="${card.docId}" data-tilt data-mobile-text-hidden="true">
                    <img src="${card.imageUrl}" alt="${card.member} - ${card.album}" class="card-image" loading="lazy">
                    <div class="card-border" style="border-image-source: linear-gradient(145deg, ${memberColor.start}, ${memberColor.end});"></div>
                    <div class="card-id">${card.id}</div>
                    
                    <div class="card-tags">
                        ${displayedTagHtml}
                    </div>

                    <div class="card-info">
                        <div class="card-text">
                            <div class="member">${card.member} (${card.group})</div>
                            <div class="album">${card.album} - ${card.version}</div>
                        </div>
                        <div class="price ${priceColorClass}">
                            ‚Ç¨${finalPrice.toFixed(2)}
                            ${hasDiscount ? `<span class="original-price">‚Ç¨${card.price.toFixed(2)}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="selected-indicator">
                        <i class="fa-solid fa-heart"></i>
                    </div>

                    <div class="status-overlay">
                        <span>${card.status}</span>
                    </div>

                    <div class="admin-card-controls">
                        <button class="edit-card-btn" title="Edit"><i class="fa-solid fa-pencil"></i></button>
                        <button class="delete-card-btn" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `;
            
            return container;
        }

        const GROUP_ORDER = ['Red Velvet', 'IU', 'aespa'];
        const MEMBER_ORDER = ['Irene', 'Seulgi', 'Wendy', 'Joy', 'Yeri', 'IU', 'Karina', 'Giselle', 'Winter', 'Ningning'];

        function customSort(a, b) {
            const groupA = GROUP_ORDER.indexOf(a.group);
            const groupB = GROUP_ORDER.indexOf(b.group);
            if (groupA !== groupB) return groupA - groupB;
            const memberA = MEMBER_ORDER.indexOf(a.member);
            const memberB = MEMBER_ORDER.indexOf(b.member);
            if (memberA !== memberB) return memberA - memberB;
            const albumCompare = a.album.localeCompare(b.album);
            if (albumCompare !== 0) return albumCompare;
            const versionCompare = a.version.localeCompare(b.version);
            if (versionCompare !== 0) return versionCompare;
            const priceA = calculateDiscountedPrice(a.price, a.discount);
            const priceB = calculateDiscountedPrice(b.price, b.discount);
            if (priceA !== priceB) return priceB - priceA;
            return a.id.localeCompare(b.id);
        }

        function applyFiltersAndSort() {
            let filteredCards = [...allCards];
            
            // Determine which set of controls to use (desktop or mobile modal)
            const isMobileView = window.innerWidth <= 768; // Based on CSS media query
            const currentSearchInput = isMobileView ? searchInputMobile : searchInputDesktop;
            const currentGroupFilter = isMobileView ? groupFilterMobile : groupFilterDesktop;
            const currentMemberFilter = isMobileView ? memberFilterMobile : memberFilterDesktop;
            const currentStatusFilter = isMobileView ? statusFilterMobile : statusFilterDesktop;
            const currentSortBy = isMobileView ? sortByMobile : sortByDesktop;

            const searchTerm = currentSearchInput.value.toLowerCase();
            const selectedGroup = currentGroupFilter.value;
            const selectedMember = currentMemberFilter.value;
            const selectedStatus = currentStatusFilter.value;

            if (searchTerm) {
                filteredCards = filteredCards.filter(c =>
                    c.member.toLowerCase().includes(searchTerm) ||
                    c.album.toLowerCase().includes(searchTerm) ||
                    c.version.toLowerCase().includes(searchTerm) ||
                    c.id.toLowerCase().includes(searchTerm)
                );
            }
            if (selectedGroup !== 'all') filteredCards = filteredCards.filter(c => c.group === selectedGroup);
            if (selectedMember !== 'all') filteredCards = filteredCards.filter(c => c.member === selectedMember);
            if (selectedStatus !== 'all') filteredCards = filteredCards.filter(c => c.status === selectedStatus);
            
            const sortValue = currentSortBy.value;
            let sortedCards;

            if (sortValue === 'default') {
                sortedCards = filteredCards.sort(customSort);
            } else {
                sortedCards = filteredCards.sort((a, b) => {
                    const priceA = calculateDiscountedPrice(a.price, a.discount);
                    const priceB = calculateDiscountedPrice(b.price, b.discount);
                    const dateA = a.dateAdded?.toDate ? a.dateAdded.toDate() : 0;
                    const dateB = b.dateAdded?.toDate ? b.dateAdded.toDate() : 0;

                    switch (sortValue) {
                        case 'price-asc': return priceA - priceB;
                        case 'price-desc': return priceB - priceA;
                        case 'date-desc': return dateB - dateA;
                        default: return 0;
                    }
                });
            }
            
            const biasMember = {
                irene: 'Irene', seulgi: 'Seulgi', wendy: 'Wendy', joy: 'Joy', yeri: 'Yeri'
            }[currentBias];
            
            if (biasMember) {
                const biasCards = sortedCards.filter(c => c.member === biasMember);
                const otherCards = sortedCards.filter(c => c.member !== biasMember);
                sortedCards = [...biasCards, ...otherCards];
            }

            renderCards(sortedCards);
        }

        function populateMemberFilters() {
            // Populate desktop member filter
            let selectedGroupDesktop = groupFilterDesktop.value;
            let membersDesktop = new Set();
            let sourceCardsDesktop = (selectedGroupDesktop === 'all') ? allCards : allCards.filter(c => c.group === selectedGroupDesktop);
            sourceCardsDesktop.forEach(card => membersDesktop.add(card.member));
            let sortedMembersDesktop = Array.from(membersDesktop).sort();

            memberFilterDesktop.innerHTML = '<option value="all">All Members</option>';
            sortedMembersDesktop.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                memberFilterDesktop.appendChild(option);
            });

            // Populate mobile member filter
            let selectedGroupMobile = groupFilterMobile.value;
            let membersMobile = new Set();
            let sourceCardsMobile = (selectedGroupMobile === 'all') ? allCards : allCards.filter(c => c.group === selectedGroupMobile);
            sourceCardsMobile.forEach(card => membersMobile.add(card.member));
            let sortedMembersMobile = Array.from(membersMobile).sort();

            memberFilterMobile.innerHTML = '<option value="all">All Members</option>';
            sortedMembersMobile.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                memberFilterMobile.appendChild(option);
            });
        }
        
        function updateFloatingBar() {
            if (selectedCards.size > 0) {
                let totalPrice = 0;
                selectedCards.forEach(docId => {
                    const card = allCards.find(c => c.docId === docId);
                    if (card) totalPrice += calculateDiscountedPrice(card.price, card.discount);
                });
                selectionInfo.textContent = `${selectedCards.size} card(s) | Total: ‚Ç¨${totalPrice.toFixed(2)}`;
                floatingBar.classList.add('visible');
            } else {
                floatingBar.classList.remove('visible');
            }
        }
        
        function calculateDiscountedPrice(originalPrice, discountPercentage) {
            if (!discountPercentage) return originalPrice;
            let discountAmount = 0;
            if (discountPercentage === 10) discountAmount = Math.max(0.50, originalPrice * 0.1);
            else if (discountPercentage === 20) discountAmount = Math.max(1.00, originalPrice * 0.2);
            let discountedPrice = Math.ceil((originalPrice - discountAmount) * 2) / 2;
            return Math.max(1.00, discountedPrice);
        }

        // --- EVENT HANDLERS ---
        
        function handleCardClick(e) {
            const cardElement = e.target.closest('.photocard');
            if (!cardElement) return;

            const docId = cardElement.dataset.docId;
            const cardData = allCards.find(c => c.docId === docId);

            // Check if it's a mobile device (based on your media query breakpoint)
            const isMobile = window.innerWidth <= 768;

            // Admin mode overrides all user interaction rules
            if (isAdmin) {
                // Admin interactions (edit/delete buttons) are handled by specific listeners
                // If not an admin button, then it's a selection click
                if (!e.target.closest('.admin-card-controls button')) {
                    toggleCardSelection(cardElement, docId);
                }
                return;
            }

            // Non-admin mode
            if (!cardData || cardData.status !== 'available') {
                cardElement.style.animation = 'shake 0.5s';
                setTimeout(() => cardElement.style.animation = '', 500);
                return; // Cannot select unavailable cards
            }

            if (isMobile) {
                const isSelectedIndicatorClick = e.target.closest('.selected-indicator');
                
                // Get the bounding rectangle of the card
                const rect = cardElement.getBoundingClientRect();
                // Calculate the x-coordinate of the click relative to the card
                const clickX = e.clientX - rect.left;
                // Determine if the click was on the left or right half
                const isLeftHalfClick = clickX < rect.width / 2;

                if (isSelectedIndicatorClick) {
                    // Tapping the heart always toggles selection
                    toggleCardSelection(cardElement, docId);
                } else if (isLeftHalfClick) {
                    // Tapping the left half toggles text visibility
                    const cardTextElement = cardElement.querySelector('.card-info .card-text');
                    if (!cardTextElement) return; // Safety check

                    const isTextCurrentlyHidden = cardElement.dataset.mobileTextHidden !== "false";
                    
                    if (isTextCurrentlyHidden) {
                        // Show text: set max-height to a large value to ensure full content visibility
                        cardTextElement.style.maxHeight = '999px'; 
                        cardTextElement.style.opacity = '1';
                        cardTextElement.style.paddingTop = '10px';
                        cardTextElement.style.paddingBottom = '10px';
                        cardElement.dataset.mobileTextHidden = "false"; // Update dataset attribute
                    } else {
                        // Hide text: set explicit height to current height, then transition to 0
                        cardTextElement.style.maxHeight = `${cardTextElement.scrollHeight}px`; // Set current height explicitly
                        requestAnimationFrame(() => {
                            cardTextElement.style.maxHeight = '0px';
                            cardTextElement.style.opacity = '0';
                            cardTextElement.style.paddingTop = '0px';
                            cardTextElement.style.paddingBottom = '0px';
                        });
                        cardElement.dataset.mobileTextHidden = "true"; // Update dataset attribute
                    }
                } else {
                    // Tapping the right half toggles selection
                    toggleCardSelection(cardElement, docId);
                }
            } else {
                // On desktop, regular click toggles selection
                toggleCardSelection(cardElement, docId);
            }
        }

        function toggleCardSelection(cardElement, docId) {
            if (selectedCards.has(docId)) {
                selectedCards.delete(docId);
                cardElement.classList.remove('selected');
            } else {
                selectedCards.add(docId);
                cardElement.classList.add('selected');
            }
            updateFloatingBar();
        }

        function openModal(modalId, card = null) {
            if (modalId === 'admin-modal') {
                openAdminForm(card);
            } else if (modalId === 'filters-modal') {
                // Sync mobile filters with desktop filters before opening
                searchInputMobile.value = searchInputDesktop.value;
                groupFilterMobile.value = groupFilterDesktop.value;
                populateMemberFilters(); // Re-populate mobile member filter based on mobile group filter
                memberFilterMobile.value = memberFilterDesktop.value;
                statusFilterMobile.value = statusFilterDesktop.value;
                sortByMobile.value = sortByDesktop.value; // Keep current mobile sort selection
            }
            document.getElementById(modalId).classList.add('visible');
        }

        function closeModal(modalId) { document.getElementById(modalId).classList.remove('visible'); }
        
        function generateCheckoutMessage() {
            const country = document.getElementById('shipping-country').value;
            const shipping = document.getElementById('shipping-method').value;
            const payment = document.getElementById('payment-method').value;
            
            let message = "Hello! I would like to buy the following card(s):\n\n";
            let totalPrice = 0;

            selectedCards.forEach(docId => {
                const card = allCards.find(c => c.docId === docId);
                if (card) {
                    const price = calculateDiscountedPrice(card.price, card.discount);
                    totalPrice += price;
                    message += `------------------------------\n${card.id}\n${card.member} (${card.group}) - ${card.album}\n${card.version}\n‚Ç¨${price.toFixed(2)}\n`;
                }
            });

            message += `------------------------------\n\nTOTAL (${selectedCards.size} cards): ‚Ç¨${totalPrice.toFixed(2)} (excl. shipping)\n\n--- Shipping & Payment ---\nShip to: ${country || 'Please specify'}\nShipping Method: ${shipping}\nPayment Method: ${payment}\n`;
            document.getElementById('generated-message').value = message;
        }
        
        function updateAdminUI(isLoggedIn) {
            isAdmin = isLoggedIn;
            document.body.classList.toggle('admin-mode', isLoggedIn);
            
            const soldOptionDesktop = document.getElementById('status-filter-sold-desktop');
            const soldOptionMobile = document.getElementById('status-filter-sold-mobile');

            if (isLoggedIn) {
                soldOptionDesktop.style.display = 'block';
                soldOptionMobile.style.display = 'block';
            } else {
                soldOptionDesktop.style.display = 'none';
                soldOptionMobile.style.display = 'none';
                if (statusFilterDesktop.value === 'sold') {
                    statusFilterDesktop.value = 'available';
                    applyFiltersAndSort();
                }
                if (statusFilterMobile.value === 'sold') {
                    statusFilterMobile.value = 'available';
                    applyFiltersAndSort();
                }
            }
        }
        
        // --- ADMIN & AUTOCOMPLETE FUNCTIONS ---
        
        function setupCustomAutocomplete(inputId, sourceArrayFn) {
            const input = document.getElementById(inputId);
            let suggestionsContainer = document.getElementById(inputId + '-suggestions');
            if (!suggestionsContainer) {
                suggestionsContainer = document.createElement('div');
                suggestionsContainer.id = inputId + '-suggestions';
                suggestionsContainer.className = 'autocomplete-suggestions neo-ui';
                input.parentNode.appendChild(suggestionsContainer);
            }
            
            const showSuggestions = () => {
                const value = input.value.toLowerCase();
                const source = sourceArrayFn();
                const filtered = (value.length === 0 && inputId === 'card-version') 
                    ? source 
                    : source.filter(item => item.toLowerCase().includes(value));

                suggestionsContainer.innerHTML = '';
                if (filtered.length > 0 && (value.length > 0 || inputId === 'card-version')) {
                    filtered.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion';
                        div.textContent = item;
                        div.addEventListener('click', () => {
                            input.value = item;
                            suggestionsContainer.style.display = 'none';
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                        });
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            };

            input.addEventListener('input', showSuggestions);
            input.addEventListener('focus', showSuggestions);

            document.addEventListener('click', (e) => {
                if (e.target !== input && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }
        
        async function generateCardId() {
            const groupInput = document.getElementById('card-group');
            const memberInput = document.getElementById('card-member');
            const idInput = document.getElementById('card-id');

            const group = groupInput.value;
            const member = memberInput.value;

            if (!group || !member) {
                idInput.value = 'Select Group & Member first';
                return;
            }

            const groupPrefix = (group.match(/[A-Z]/g) || []).join('').substring(0, 2);
            const memberPrefix = member.charAt(0);
            const prefix = `${groupPrefix}-${memberPrefix}-`.toUpperCase();

            const cardsWithPrefix = allCards.filter(c => c.id && c.id.startsWith(prefix));
            let maxNum = 0;
            cardsWithPrefix.forEach(c => {
                const numPart = c.id.split('-')[2];
                if (numPart) {
                    const num = parseInt(numPart, 10);
                    if (!isNaN(num) && num > maxNum) maxNum = num;
                }
            });

            const newNum = (maxNum + 1).toString().padStart(3, '0');
            idInput.value = prefix + newNum;
        }
        
        function openAdminForm(card = null) {
            const form = document.getElementById('admin-form');
            form.reset();
            document.getElementById('admin-modal-title').textContent = card ? 'Edit Card' : 'Add New Card';
            document.getElementById('card-doc-id').value = card ? card.docId : '';
            document.getElementById('card-id').value = card ? card.id : '';
            document.getElementById('card-group').value = card ? card.group : '';
            document.getElementById('card-member').value = card ? card.member : '';
            document.getElementById('card-album').value = card ? card.album : '';
            document.getElementById('card-version').value = card ? card.version : '';
            document.getElementById('card-image-url').value = card ? card.imageUrl : '';
            document.getElementById('card-price').value = card ? card.price : '';
            document.getElementById('card-is-rare').checked = card ? card.isRare : false;
            if (!card) generateCardId();
        }

        async function saveCard(andAddNext = false) {
            const docId = document.getElementById('card-doc-id').value;
            
            const cardData = {
                id: document.getElementById('card-id').value,
                group: document.getElementById('card-group').value,
                member: document.getElementById('card-member').value,
                album: document.getElementById('card-album').value,
                version: document.getElementById('card-version').value,
                imageUrl: document.getElementById('card-image-url').value,
                price: parseFloat(document.getElementById('card-price').value),
                status: 'available',
                isRare: document.getElementById('card-is-rare').checked,
                discount: 0
            };
            if (cardData.id.includes('Select')) {
                // Use a custom message box instead of alert
                showMessageBox('Please ensure a valid ID is generated.', 'Error');
                return;
            }
            try {
                if (docId) await updateDoc(doc(db, 'cards', docId), cardData);
                else await addDoc(collection(db, 'cards'), { ...cardData, dateAdded: serverTimestamp() });
                
                if (andAddNext) {
                    const group = cardData.group;
                    const member = cardData.member;
                    openAdminForm(null);
                    document.getElementById('card-group').value = group;
                    document.getElementById('card-member').value = member;
                    generateCardId();
                } else {
                    closeModal('admin-modal');
                }
                fetchAndRenderCards();
            } catch (error) {
                console.error("Error saving card: ", error);
                showMessageBox("Error saving card. Check console for details.", 'Error');
            }
        }
        
        async function handleDeleteCard(docId) {
            // Use a custom message box for confirmation
            showConfirmationBox('Permanently delete this card?', async () => {
                try {
                    await deleteDoc(doc(db, "cards", docId));
                    fetchAndRenderCards();
                } catch (error) {
                    console.error("Error deleting card:", error);
                    showMessageBox("Could not delete card.", 'Error');
                }
            });
        }

        async function handleBulkAction(action) {
            if (!action || selectedCards.size === 0) {
                showMessageBox("Please select an action and at least one card.", 'Info');
                return;
            }
            if (action === 'delete') {
                showConfirmationBox(`Delete ${selectedCards.size} cards? This cannot be undone.`, async () => {
                    loadingSpinner.style.display = 'block';
                    const promises = [];
                    selectedCards.forEach(docId => {
                        const cardRef = doc(db, 'cards', docId);
                        promises.push(deleteDoc(cardRef));
                    });
                    try {
                        await Promise.all(promises);
                    } catch (error) {
                        console.error("Error with bulk action: ", error);
                        showMessageBox("Error performing bulk delete. Check console for details.", 'Error');
                    } finally {
                        selectedCards.clear();
                        updateFloatingBar();
                        fetchAndRenderCards();
                    }
                });
                return;
            }

            loadingSpinner.style.display = 'block';
            const promises = [];
            selectedCards.forEach(docId => {
                const cardRef = doc(db, 'cards', docId);
                if (action.startsWith('set-')) promises.push(updateDoc(cardRef, { status: action.split('-')[1] }));
                else if (action.startsWith('discount-')) promises.push(updateDoc(cardRef, { discount: parseInt(action.split('-')[1]) }));
                else if (action === 'toggle-rare') {
                    const card = allCards.find(c => c.docId === docId);
                    if (card) promises.push(updateDoc(cardRef, { isRare: !card.isRare }));
                }
            });

            try {
                await Promise.all(promises);
            } catch (error) {
                console.error("Error with bulk action: ", error);
                showMessageBox("Error performing bulk action. Check console for details.", 'Error');
            } finally {
                selectedCards.clear();
                updateFloatingBar();
                fetchAndRenderCards();
            }
        }

        // Custom Message Box and Confirmation Box
        function showMessageBox(message, type = 'Info') {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay visible';
            modalOverlay.innerHTML = `
                <div class="modal neo-ui">
                    <div class="modal-header">
                        <h2>${type}</h2>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-content">
                        <p>${message}</p>
                        <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                            <button class="btn close-message-box">OK</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modalOverlay);

            modalOverlay.querySelector('.close-modal').addEventListener('click', () => document.body.removeChild(modalOverlay));
            modalOverlay.querySelector('.close-message-box').addEventListener('click', () => document.body.removeChild(modalOverlay));
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) document.body.removeChild(modalOverlay);
            });
        }

        function showConfirmationBox(message, onConfirm) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay visible';
            modalOverlay.innerHTML = `
                <div class="modal neo-ui">
                    <div class="modal-header">
                        <h2>Confirm Action</h2>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-content">
                        <p>${message}</p>
                        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-secondary confirm-cancel">Cancel</button>
                            <button class="btn confirm-ok">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modalOverlay);

            modalOverlay.querySelector('.close-modal').addEventListener('click', () => document.body.removeChild(modalOverlay));
            modalOverlay.querySelector('.confirm-cancel').addEventListener('click', () => document.body.removeChild(modalOverlay));
            modalOverlay.querySelector('.confirm-ok').addEventListener('click', () => {
                onConfirm();
                document.body.removeChild(modalOverlay);
            });
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) document.body.removeChild(modalOverlay);
            });
        }


        // --- EVENT LISTENERS INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchMetadata(); // Fetch metadata first
            fetchAndRenderCards();

            // --- AUTHENTICATION ---
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');

            onAuthStateChanged(auth, (user) => {
                updateAdminUI(!!user);
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginError.style.display = 'none';
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    closeModal('login-modal');
                    loginForm.reset();
                } catch (error) {
                    console.error("Login failed:", error.message);
                    loginError.textContent = "Login failed. Please check your email and password.";
                    loginError.style.display = 'block';
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth);
            });

            document.getElementById('admin-toggle-btn').addEventListener('click', () => {
                if (!isAdmin) {
                    openModal('login-modal');
                }
            });

            // Desktop Filter/Sort Listeners
            [searchInputDesktop, groupFilterDesktop, memberFilterDesktop, statusFilterDesktop, sortByDesktop].forEach(el => el.addEventListener('change', applyFiltersAndSort));
            searchInputDesktop.addEventListener('keyup', applyFiltersAndSort);
            groupFilterDesktop.addEventListener('change', populateMemberFilters);

            // Mobile Filter/Sort Listeners (inside modal)
            document.getElementById('filter-toggle-btn').addEventListener('click', () => openModal('filters-modal'));
            document.getElementById('apply-filters-btn').addEventListener('click', () => {
                // Sync desktop filters with mobile filters after applying
                searchInputDesktop.value = searchInputMobile.value;
                groupFilterDesktop.value = groupFilterMobile.value;
                memberFilterDesktop.value = memberFilterMobile.value;
                statusFilterDesktop.value = statusFilterMobile.value;
                sortByDesktop.value = sortByMobile.value;

                applyFiltersAndSort();
                closeModal('filters-modal');
            });
            document.getElementById('reset-filters-btn').addEventListener('click', () => {
                searchInputMobile.value = '';
                groupFilterMobile.value = 'all';
                memberFilterMobile.value = 'all'; // Will be repopulated by populateMemberFilters
                statusFilterMobile.value = 'available';
                sortByMobile.value = 'default';
                populateMemberFilters(); // Ensure members are reset correctly
                
                // Also reset desktop filters
                searchInputDesktop.value = '';
                groupFilterDesktop.value = 'all';
                memberFilterDesktop.value = 'all';
                statusFilterDesktop.value = 'available';
                sortByDesktop.value = 'default';

                applyFiltersAndSort();
                closeModal('filters-modal');
            });
            groupFilterMobile.addEventListener('change', populateMemberFilters);
            
            cardGrid.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-card-btn');
                if (editBtn) {
                    const docId = editBtn.closest('.card-container').dataset.docId;
                    const card = allCards.find(c => c.docId === docId);
                    openModal('admin-modal', card);
                    return;
                }

                const deleteBtn = e.target.closest('.delete-card-btn');
                if (deleteBtn) {
                    const docId = deleteBtn.closest('.card-container').dataset.docId;
                    handleDeleteCard(docId);
                    return;
                }
                
                handleCardClick(e);
            });
            
            document.getElementById('unselect-all-btn').addEventListener('click', () => {
                selectedCards.forEach(docId => cardGrid.querySelector(`.photocard[data-doc-id="${docId}"]`)?.classList.remove('selected'));
                selectedCards.clear();
                updateFloatingBar();
            });
            document.getElementById('checkout-btn').addEventListener('click', () => { 
                if (selectedCards.size === 0) {
                    showMessageBox("Please select at least one card to checkout.", "Info");
                    return;
                }
                generateCheckoutMessage(); 
                openModal('checkout-modal'); 
            });
            document.getElementById('back-to-top').addEventListener('click', () => window.scrollTo(0, 0));
            document.getElementById('info-btn').addEventListener('click', () => openModal('info-modal'));

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    // Only close if clicking on the overlay itself, not its children
                    if (e.target === overlay && overlay.id !== 'admin-modal') closeModal(overlay.id);
                });
            });
            document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-overlay').id)));
            
            document.getElementById('copy-message-btn').addEventListener('click', () => {
                const textarea = document.getElementById('generated-message');
                textarea.select();
                document.execCommand('copy');
                showMessageBox('Message copied!', 'Success');
            });
            ['shipping-country', 'shipping-method', 'payment-method'].forEach(id => document.getElementById(id).addEventListener('input', generateCheckoutMessage));

            // Admin Modal Setup
            document.getElementById('add-card-btn').addEventListener('click', () => openModal('admin-modal', null));
            document.getElementById('admin-form').addEventListener('submit', (e) => { e.preventDefault(); saveCard(false); });
            document.getElementById('save-and-add-next-btn').addEventListener('click', () => saveCard(true));
            document.getElementById('bulk-actions-container').addEventListener('click', (e) => {
                const button = e.target.closest('.bulk-btn');
                if (button) {
                    handleBulkAction(button.dataset.action);
                }
            });
            
            setupCustomAutocomplete('card-group', () => METADATA.groups || []);
            setupCustomAutocomplete('card-member', () => {
                const group = document.getElementById('card-group').value.replace(/\s/g, '');
                return METADATA[group]?.members || [];
            });
            setupCustomAutocomplete('card-album', () => {
                const group = document.getElementById('card-group').value.replace(/\s/g, '');
                const member = document.getElementById('card-member').value;
                const groupData = METADATA[group];
                if (!groupData) return [];
                const groupAlbums = [...(groupData.albums || []), ...(groupData.merch || [])];
                const memberAlbums = groupData.member_albums?.[member] || [];
                return [...new Set([...groupAlbums, ...memberAlbums])];
            });
            setupCustomAutocomplete('card-version', () => {
                const group = document.getElementById('card-group').value.replace(/\s/g, '');
                const album = document.getElementById('card-album').value;
                return METADATA[group]?.versions?.[album] || [];
            });

            document.getElementById('card-group').addEventListener('change', generateCardId);
            document.getElementById('card-member').addEventListener('change', generateCardId);

            // Bias Theme Selector
            document.querySelector('.bias-selector').addEventListener('click', e => {
                const bubble = e.target.closest('.bias-bubble');
                if (!bubble) return;
                document.querySelectorAll('.bias-bubble').forEach(b => b.classList.remove('active'));
                bubble.classList.add('active');
                currentBias = bubble.dataset.theme;
                document.body.className = `theme-${currentBias}`;
                if (isAdmin) document.body.classList.add('admin-mode');
                applyFiltersAndSort(); // Re-sort when bias changes
            });
        });
        
        // --- END OF JAVASCRIPT ---
    </script>
    
    <!-- Tilt.js for card effect -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.1/vanilla-tilt.min.js"></script>
</body>
</html>
