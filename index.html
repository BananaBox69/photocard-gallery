<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Pop Photocard Sales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg, #f3f4f6);
            transition: background-color 0.5s ease;
            /* Adjusted background texture with more subtle and spaced out emojis */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Ctext x='20' y='40' font-size='20' fill='%23d1d5db' opacity='0.15'%3E%F0%9F%90%B0%3C/text%3E%3Ctext x='100' y='60' font-size='20' fill='%23d1d5db' opacity='0.15'%3E%F0%9F%90%BB%3C/text%3E%3Ctext x='40' y='120' font-size='20' fill='%23d1d5db' opacity='0.15'%3E%F0%9F%90%B6%3C/text%3E%3Ctext x='140' y='140' font-size='20' fill='%23d1d5db' opacity='0.15'%3E%F0%9F%90%A5%3C/text%3E%3Ctext x='80' y='180' font-size='20' fill='%23d1d5db' opacity='0.15'%3E%F0%9F%90%A2%3C/text%3E%3C/svg%3E");
            background-repeat: repeat;
        }
        .theme-bg-gradient {
            background-image: linear-gradient(to right, var(--color-primary), var(--color-secondary));
        }
        .theme-text { color: var(--color-primary); }
        .theme-ring-focus:focus {
            --tw-ring-color: var(--color-primary);
        }
        .card-selected {
            box-shadow: 0 0 0 3px var(--color-primary);
        }
        #control-panel.theme-bg-gradient select,
        #control-panel.theme-bg-gradient input {
            background-color: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
            color: white;
        }
        #control-panel.theme-bg-gradient select option {
            color: #333;
        }
        #control-panel.theme-bg-gradient ::placeholder {
            color: rgba(255,255,255,0.7);
        }
        .sold-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(30, 41, 59, 0.75); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold; border-radius: 0.5rem;
            opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
        }
        .group-item:hover .sold-overlay { opacity: 1; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center; z-index: 50;
        }
        .edit-pen {
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .title-container:hover .edit-pen, .edit-pen.admin-visible {
            opacity: 1;
        }
        .autocomplete-suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            width: 100%;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .suggestion-item:hover, .suggestion-active {
            background-color: #e5e7eb;
        }
        /* New gradient styles for tags */
        .tag-new {
            background-image: linear-gradient(to right, #60A5FA, #3B82F6);
            color: white;
        }
        .tag-sale {
            background-image: linear-gradient(to right, #EF4444, #DC2626);
            color: white;
        }
        .tag-super-sale {
            background-image: linear-gradient(to right, #A855F7, #9333EA);
            color: white;
        }
        .tag-reserved {
            background-image: linear-gradient(to right, #F59E0B, #D97706);
            color: white;
        }
        .tag-sold {
            background-color: #DC2626;
            color: white;
        }

        /* Re-added and refined gradient styles for main title and subtitle */
        #main-title {
            background: linear-gradient(to right, var(--color-primary), var(--color-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            display: inline-block;
        }
        #subtitle {
            background: linear-gradient(to right, var(--color-primary), var(--color-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            display: inline-block;
        }

        /* Floating Buttons - Consistent Styling and Positioning */
        .floating-btn {
            position: fixed;
            border-radius: 9999px; /* Fully rounded */
            width: 56px; /* w-14 */
            height: 56px; /* h-14 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .floating-btn:hover {
            transform: scale(1.1);
        }

        /* Specific positioning for each button */
        #cart-button {
            bottom: 96px; /* 24px (info) + 72px (spacing) = 96px */
            right: 24px;
            background-image: linear-gradient(to right, var(--color-primary), var(--color-secondary));
            color: white;
            z-index: 30;
        }
        #cart-button.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        #info-button {
            bottom: 24px; /* Base position */
            right: 24px;
            background-color: #4a5568;
            color: white;
            z-index: 30;
        }

        #deselect-all-btn {
            bottom: 96px; /* Same bottom as cart-button */
            left: 24px;
            background-color: #ef4444;
            color: white;
            z-index: 35; /* Higher z-index to be above back-to-top */
        }
        #deselect-all-btn:not(.show) { /* Hide when not 'show' */
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        #deselect-all-btn.show {
            opacity: 1;
            visibility: visible;
        }

        #back-to-top-btn {
            bottom: 24px; /* Same bottom as info-button */
            left: 24px;
            background-color: #4a5568;
            color: white;
            z-index: 40; /* Highest z-index for back-to-top */
        }
        #back-to-top-btn:not(.show) { /* Hide when not 'show' */
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        #back-to-top-btn.show {
            opacity: 1;
            visibility: visible;
        }

        /* Footer Admin Controls and Timestamp */
        #footer-admin-controls {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }
        #footer-admin-controls .admin-buttons-group {
            display: flex;
            gap: 8px;
        }
        /* Styles for the bottom part of the card container */
        .card-text-area {
            padding: 1rem; /* Tailwind's p-4 equivalent */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            color: white; /* Default text color for this area */
        }
        /* Ensure all text within this area is white, overriding any inherited colors */
        .card-text-area p {
            color: white !important;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="disclaimer-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-gray-800">
            <h3 class="text-2xl font-bold mb-4">Disclaimer & Terms of Use</h3>
            <div id="disclaimer-content" class="prose max-w-none text-sm mb-6 max-h-80 overflow-y-auto">
                </div>
            <div class="flex justify-between space-x-2">
                <button onclick="window.declineDisclaimer()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Decline & Exit</button>
                <button onclick="window.acceptDisclaimer()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Accept & Continue</button>
            </div>
        </div>
    </div>

    <div id="disclaimer-edit-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl text-gray-800">
            <h3 class="text-xl font-bold mb-4">Edit Disclaimer Content</h3>
            <textarea id="disclaimer-edit-textarea" class="w-full h-96 p-2 border border-gray-300 rounded-md mb-4 resize-y"></textarea>
            <div class="flex justify-end space-x-2">
                <button onclick="window.closeModal('disclaimer-edit-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button onclick="window.saveDisclaimerContent()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Disclaimer</button>
            </div>
        </div>
    </div>

    <div id="admin-login-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Admin Login</h3>
            <input type="email" id="admin-email-input" class="w-full p-2 border border-gray-300 rounded-md mb-2" placeholder="Admin Email">
            <input type="password" id="admin-password-input" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="Password">
            <p id="admin-login-message" class="text-red-500 text-sm hidden mb-2"></p>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="window.closeModal('admin-login-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button onclick="window.checkAdminPassword()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Login</button>
            </div>
        </div>
    </div>
    
    <div id="add-card-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-gray-800">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Add a New Card</h3>
            <form id="add-card-form" class="space-y-3">
                <input type="hidden" id="card-id-input">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Card ID</label>
                    <input type="text" id="card-display-id-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative autocomplete-container">
                        <label class="block text-sm font-medium text-gray-700">Group</label>
                        <input type="text" id="card-group-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required autocomplete="off">
                        <div id="group-suggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                    <div class="relative autocomplete-container">
                        <label class="block text-sm font-medium text-gray-700">Member</label>
                        <input type="text" id="card-member-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required autocomplete="off">
                        <div id="member-suggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                </div>
                <div class="relative autocomplete-container">
                    <label class="block text-sm font-medium text-gray-700">Album / Origin</label>
                    <input type="text" id="card-album-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required autocomplete="off">
                    <div id="album-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
                <div class="relative autocomplete-container">
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="card-description-input" rows="2" class="mt-1 w-full p-2 border border-gray-300 rounded-md" autocomplete="off"></textarea>
                    <div id="description-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Price (€)</label>
                    <input type="number" step="0.01" id="card-price-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Image URL</label>
                    <input type="text" id="card-image-url-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="flex justify-between items-center pt-4">
                    <span id="save-another-confirm" class="text-green-600 opacity-0 transition-opacity">Saved!</span>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="window.closeModal('add-card-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                        <button type="button" onclick="window.saveAndAddAnother()" class="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700">Save & Add Another</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save & Close</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-2">Are you sure?</h3>
            <p class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button onclick="window.closeModal('delete-confirm-modal')" class="px-6 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    <div id="title-edit-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Edit Title</h3>
            <input type="text" id="title-edit-input" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="New Title">
            <div class="flex justify-end space-x-2">
                <button onclick="window.closeModal('title-edit-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button onclick="window.saveTitle()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>
    
    <div id="subtitle-edit-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Edit Subtitle</h3>
            <input type="text" id="subtitle-edit-input" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="New Subtitle">
            <div class="flex justify-end space-x-2">
                <button onclick="window.closeModal('subtitle-edit-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button onclick="window.saveSubtitle()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>

    <div id="export-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl text-gray-800 flex flex-col" style="max-height: 90vh;">
            <h3 class="text-2xl font-bold mb-4">Export Selection</h3>
            <p class="text-sm text-gray-600 mb-4">Please fill in the details below, then copy the text and send it to me!</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Shipping Method</label>
                    <select id="export-shipping" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        <option>Cheapest</option>
                        <option>Tracked</option>
                        <option>Insured</option>
                    </select>
                </div>
                <div class="relative autocomplete-container">
                    <label class="block text-sm font-medium text-gray-700">Ship to Country</label>
                    <input type="text" id="export-country" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Germany" autocomplete="off">
                    <div id="country-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Payment Method</label>
                    <select id="export-payment" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        <option>PayPal F&F</option>
                        <option>Wise</option>
                        <option>Bank Transfer</option>
                    </select>
                </div>
            </div>
            <div class="flex-grow min-h-0">
                <textarea id="export-textarea" readonly class="w-full h-96 p-3 bg-gray-100 border border-gray-300 rounded-md resize-none font-mono text-sm"></textarea>
            </div>
            <div class="flex justify-between items-center mt-4">
                 <span id="export-validation-message" class="text-red-500 text-sm hidden"></span>
                 <a href="https://www.instagram.com/bananatrades877/" target="_blank" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-md hover:from-purple-600 hover:to-pink-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                    <span>Send on Instagram</span>
                </a>
                <div class="flex space-x-2">
                    <button type="button" onclick="window.closeModal('export-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button onclick="window.copyExportText()" id="copy-export-btn" class="px-4 py-2 text-white rounded-md theme-bg-gradient">Copy Text</button>
                </div>
            </div>
        </div>
    </div>
    <div id="bulk-price-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Bulk Edit Price</h3>
            <p class="text-sm text-gray-600 mb-2">Enter a new price for all selected cards.</p>
            <input type="number" step="0.01" id="bulk-price-input" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="e.g., 10.50">
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="window.closeModal('bulk-price-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button onclick="window.bulkUpdatePrice()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Set Price</button>
            </div>
        </div>
    </div>

    <div id="info-sheet-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl text-gray-800 flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Selling Process Info</h3>
                <span id="edit-info-sheet-btn" class="edit-pen hidden text-gray-500" onclick="window.openInfoSheetEditModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                </span>
            </div>
            <div id="info-sheet-content" class="prose max-w-none flex-grow overflow-y-auto">
                </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="window.closeModal('info-sheet-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div id="info-sheet-edit-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl text-gray-800">
            <h3 class="text-xl font-bold mb-4">Edit Selling Process Info</h3>
            <textarea id="info-sheet-edit-textarea" class="w-full h-96 p-2 border border-gray-300 rounded-md mb-4 resize-y"></textarea>
            <div class="flex justify-end space-x-2">
                <button onclick="window.closeModal('info-sheet-edit-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button onclick="window.saveInfoSheetContent()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-gray-800">
            <h3 class="text-2xl font-bold mb-4">Statistics Overview</h3>
            <div class="space-y-3">
                <p class="text-lg"><span class="font-semibold">Total Cards:</span> <span id="total-cards-stat">0</span></p>
                <p class="text-lg"><span class="font-semibold">Sold Cards:</span> <span id="sold-cards-stat">0</span></p>
                <p class="text-lg"><span class="font-semibold">Reserved Cards:</span> <span id="reserved-cards-stat">0</span></p>
                <p class="text-lg"><span class="font-semibold">On Sale Cards:</span> <span id="on-sale-cards-stat">0</span></p>
                <p class="text-lg"><span class="font-semibold">On Super Sale Cards:</span> <span id="on-super-sale-cards-stat">0</span></p>
                <p class="text-lg"><span class="font-semibold">Total Inventory Value:</span> <span id="available-value-stat">€0.00</span></p>
                <p class="text-lg"><span class="font-semibold">Total Sold Value:</span> <span id="sold-value-stat">€0.00</span></p>
                <p class="text-lg"><span class="font-semibold">Total Discount Value:</span> <span id="total-discount-value-stat">€0.00</span></p>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" onclick="window.closeModal('stats-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 pb-24">
        
        <div class="mb-8 text-center">
            <h2 class="font-bold text-gray-700 text-xl mb-2">Choose your bias!</h2>
            <div id="theme-switcher" class="flex justify-center items-center gap-3"></div>
        </div>

        <header class="text-center mb-8 relative">
            <div class="flex justify-center items-center gap-3 title-container">
                 <h1 id="main-title" class="text-4xl md:text-5xl font-bold text-gray-900 transition-colors duration-500">Photocard Sale</h1>
                 <span id="edit-title-btn" class="edit-pen hidden text-gray-500" onclick="window.openTitleEditModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                 </span>
            </div>
            <div class="flex justify-center items-center gap-2 title-container">
                <p id="subtitle" class="text-lg text-gray-600 mt-2 transition-colors duration-500">Welcome to my collection! Feel free to browse.</p>
                <span id="edit-subtitle-btn" class="edit-pen hidden text-gray-500 mt-2" onclick="window.openSubtitleEditModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                </span>
            </div>
        </header>

        <div id="control-panel" class="bg-white/80 backdrop-blur-sm p-4 rounded-lg shadow-md mb-8 sticky top-4 z-10 transition-all duration-500">
             <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="search" placeholder="Search..." class="w-full rounded-md border-gray-300 shadow-sm p-2 theme-ring-focus">
                <select id="groupFilter" class="w-full rounded-md border-gray-300 shadow-sm p-2 theme-ring-focus">
                    <option value="all">All Groups</option>
                </select>
                <div id="status-filter-wrapper">
                    <select id="statusFilter" class="w-full rounded-md border-gray-300 shadow-sm p-2 theme-ring-focus">
                        <option value="all">All Statuses</option>
                        <option value="available">Available</option>
                        <option value="on-hold">On Hold</option>
                        <option value="sold">Sold</option>
                        <option value="new">New</option>
                        <option value="sale">Sale</option>
                        <option value="super-sale">Super Sale</option>
                    </select>
                </div>
                <select id="sortOrder" class="w-full rounded-md border-gray-300 shadow-sm p-2 theme-ring-focus">
                    <option value="default">Default Sort</option>
                    <option value="price-desc">Price: High to Low</option>
                    <option value="price-asc">Price: Low to High</option>
                    <option value="date-desc">Newest Added</option>
                    <option value="id-asc">ID: A to Z</option>
                </select>
             </div>
             <div class="flex items-center justify-between mt-4">
                <button id="add-card-btn" onclick="window.openAddCardModal()" class="hidden px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Add New Card</button>
                <div id="bulk-action-bar" class="hidden w-full">
                    <div class="bg-indigo-100 border border-indigo-200 rounded-md p-2 flex justify-between items-center">
                        <div>
                            <span id="bulk-count" class="font-bold">0</span> cards selected
                        </div>
                        <div class="flex items-center gap-1 flex-wrap justify-end">
                            <button onclick="window.bulkToggleDiscount('sale')" class="px-2 py-1 bg-red-500 text-white rounded-md text-xs hover:bg-red-600">10% Off</button>
                            <button onclick="window.bulkToggleDiscount('super-sale')" class="px-2 py-1 bg-purple-700 text-white rounded-md text-xs hover:bg-purple-800">20% Off</button>
                            <button onclick="window.openBulkPriceModal()" class="px-2 py-1 bg-blue-600 text-white rounded-md text-xs hover:bg-blue-700">Set Price</button>
                            <button onclick="window.bulkUpdateStatus('available')" class="px-2 py-1 bg-green-600 text-white rounded-md text-xs hover:bg-green-700">Mark Available</button>
                            <button onclick="window.bulkUpdateStatus('on-hold')" class="px-2 py-1 bg-yellow-500 text-white rounded-md text-xs hover:bg-yellow-600">Mark Reserved</button>
                            <button onclick="window.bulkUpdateStatus('sold')" class="px-2 py-1 bg-red-600 text-white rounded-md text-xs hover:bg-red-700">Mark Sold</button>
                            <button onclick="window.deselectAll()" class="px-2 py-1 bg-gray-200 text-gray-800 rounded-md text-xs hover:bg-gray-300">Deselect All</button>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <div id="photocard-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6"></div>
        <div id="no-results" class="hidden text-center py-16">
            <h3 class="text-2xl font-semibold text-gray-700">No cards found!</h3>
            <p class="text-gray-500 mt-2">Try changing your search or filter settings.</p>
        </div>
        
        <div id="footer-admin-controls" class="flex flex-col items-center">
            <div class="admin-buttons-group">
                <button id="admin-login-btn" onclick="window.openModal('admin-login-modal')" class="px-3 py-1.5 bg-white text-gray-700 border border-gray-300 text-xs font-bold rounded-md hover:bg-gray-100">Admin</button>
                <button id="admin-logout-btn" onclick="window.logoutAdmin()" class="hidden px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded-md hover:bg-red-700">Exit Admin</button>
                <button id="open-stats-modal-btn" onclick="window.openStatsModal()" class="hidden px-3 py-1.5 bg-purple-600 text-white text-xs font-bold rounded-md hover:bg-purple-700">View Stats</button>
                <button id="edit-disclaimer-btn" onclick="window.openDisclaimerEditModal()" class="hidden px-3 py-1.5 bg-orange-500 text-white text-xs font-bold rounded-md hover:bg-orange-600">Edit Disclaimer</button>
            </div>
            <p id="last-updated-display" class="text-xs text-gray-500 mt-1"></p>
        </div>
    </div>
    
    <button id="cart-button" onclick="window.openExportModal()" class="hidden floating-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
    </button>

    <button id="info-button" onclick="window.openInfoSheetModal()" class="floating-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
    </button>

    <button id="deselect-all-btn" onclick="window.deselectAll()" class="floating-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>

    <button id="back-to-top-btn" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" class="floating-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
    </button>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDoc, setDoc, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        const firebaseConfig = {
          apiKey: "AIzaSyAmTGZo-kU-HsDwczXb2sjTw5VZgCDJn68",
          authDomain: "k-pop-price-list-pro.firebaseapp.com",
          projectId: "k-pop-price-list-pro",
          storageBucket: "k-pop-price-list-pro.appspot.com",
          messagingSenderId: "386977468923",
          appId: "1:386977468923:web:4fecd8b5971976063e7b5e"
        };
        
        const MEMBER_COLORS = {
            // Red Velvet members, using their theme primary colors as base
            'irene': '#F472B6', // Irene's primary from THEMES
            'seulgi': '#FBBF24', // Seulgi's primary from THEMES
            'wendy': '#60A5FA', // Wendy's primary from THEMES
            'joy': '#34D399', // Joy's primary from THEMES
            'yeri': '#A78BFA', // Yeri's primary from THEMES
            // New vibrant colors for other members
            'iu': '#9370DB', // MediumPurple
            'karina': '#1E90FF', // DodgerBlue (vibrant blue)
            'giselle': '#4B0082', // Indigo (deep, vibrant purple)
            'winter': '#00CED1', // DarkTurquoise (vibrant blue-green)
            'ningning': '#FF1493' // DeepPink (vibrant pink)
        };

        const THEMES = {
            'Red Velvet': { primary: '#F05252', secondary: '#F87171', initial: 'RV' }, // Red
            'Irene': { primary: '#F472B6', secondary: '#FBCFE8', initial: 'I' }, // Pink
            'Seulgi': { primary: '#FBBF24', secondary: '#FCD34D', initial: 'S' }, // Amber
            'Wendy': { primary: '#60A5FA', secondary: '#93C5FD', initial: 'W' }, // Blue
            'Joy': { primary: '#34D399', secondary: '#86EFAC', initial: 'J' }, // Green
            'Yeri': { primary: '#A78BFA', secondary: '#C4B5FD', initial: 'Y' }  // Violet
        };

        const GROUP_ABBR = { 'Red Velvet': 'RV', 'IU': 'IU', 'aespa': 'AE' };
        const GROUP_ORDER = ['Red Velvet', 'IU', 'aespa'];
        const MEMBER_ORDER = ['Irene', 'Seulgi', 'Wendy', 'Joy', 'Yeri', 'IU', "Karina", "Giselle", "Winter", "Ningning"];

        const ARTIST_DATA = {
            "Red Velvet": {
                members: ["Irene", "Seulgi", "Wendy", "Joy", "Yeri"],
                albums: ["Ice Cream Cake", "The Red", "The Velvet", "Russian Roulette", "Rookie", "The Red Summer", "Perfect Velvet", "The Perfect Red Velvet", "Summer Magic", "#Cookie Jar", "RBB", "Sappy", "The ReVe Festival: Day 1", "The ReVe Festival: Day 2", "The ReVe Festival: Finale", "Queendom", "Bloom", "The ReVe Festival 2022 - Feel My Rhythm", "The ReVe Festival 2022 - Birthday", "Chill Kill", "Cosmic", "Like a Flower", "28 Reasons", "Accidentally on Purpose", "Like Water", "Wish You Hell", "Hello", "Monster", "Naughty", "Tilt"]
            },
            "IU": {
                members: ["IU"],
                albums: ["Lost and Found", "Growing Up", "IU...IM", "Real", "Real+", "Last Fantasy", "Spring of a Twenty Year Old", "Modern Times", "Modern Times - Epilogue", "A Flower Bookmark", "Chat-Shire", "Palette", "A Flower Bookmark 2", "Love Poem", "Lilac", "Pieces", "The Winning", "A Flower Bookmark 3"]
            },
            "aespa": {
                members: ["Karina", "Giselle", "Winter", "Ningning"],
                albums: ["Savage", "Girls", "My World", "Drama", "Armageddon", "Whiplash", "Dirty Work"]
            }
        };

        const COUNTRY_LIST = ["Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo, Democratic Republic of the","Congo, Republic of the","Costa Rica","Cote d'Ivoire","Croatia","Cuba","Cyprus","Czechia","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kosovo","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Korea","North Macedonia","Norway","Oman","Pakistan","Palau","Palestine State","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal","Qatar","Romania","Russia","Rwanda","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Korea","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria","Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States of America","Uruguay","Uzbekistan","Vanuatu","Vatican City","Venezuela","Vietnam","Yemen","Zambia","Zimbabwe"];

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // Initialize Firebase Auth
        const photocardsCollection = collection(db, "photocards");
        const settingsDoc = doc(db, "settings", "main");
        const infoSheetDoc = doc(db, "settings", "infoSheet");
        const disclaimerDoc = doc(db, "settings", "disclaimer"); // New disclaimer document
        // const adminSettingsDoc is no longer needed with Firebase Auth

        let allCards = [];
        let isAdmin = false;
        let selectedCards = [];
        let currentBias = null;
        let unsubscribePhotocards = null; // To store the unsubscribe function for photocards listener

        const ui = {
            grid: document.getElementById('photocard-grid'),
            searchInput: document.getElementById('search'),
            groupFilter: document.getElementById('groupFilter'),
            statusFilter: document.getElementById('statusFilter'),
            sortOrder: document.getElementById('sortOrder'),
            addCardBtn: document.getElementById('add-card-btn'),
            addCardForm: document.getElementById('add-card-form'),
            modalTitle: document.getElementById('modal-title'),
            mainTitle: document.getElementById('main-title'),
            editTitleBtn: document.getElementById('edit-title-btn'),
            adminLoginBtn: document.getElementById('admin-login-btn'),
            adminLogoutBtn: document.getElementById('admin-logout-btn'),
            deleteConfirmBtn: document.getElementById('confirm-delete-btn'),
            titleEditInput: document.getElementById('title-edit-input'),
            adminEmailInput: document.getElementById('admin-email-input'),
            adminPasswordInput: document.getElementById('admin-password-input'),
            adminLoginMessage: document.getElementById('admin-login-message'),
            cardGroupInput: document.getElementById('card-group-input'),
            cardMemberInput: document.getElementById('card-member-input'),
            cardAlbumInput: document.getElementById('card-album-input'),
            noResults: document.getElementById('no-results'),
            statusFilterWrapper: document.getElementById('status-filter-wrapper'),
            cartButton: document.getElementById('cart-button'),
            cartCount: document.getElementById('cart-count'),
            exportTextarea: document.getElementById('export-textarea'),
            exportShipping: document.getElementById('export-shipping'),
            exportCountry: document.getElementById('export-country'),
            exportPayment: document.getElementById('export-payment'),
            copyExportBtn: document.getElementById('copy-export-btn'),
            bulkActionBar: document.getElementById('bulk-action-bar'),
            bulkCount: document.getElementById('bulk-count'),
            bulkPriceInput: document.getElementById('bulk-price-input'),
            themeSwitcher: document.getElementById('theme-switcher'),
            controlPanel: document.getElementById('control-panel'),
            subtitle: document.getElementById('subtitle'),
            editSubtitleBtn: document.getElementById('edit-subtitle-btn'),
            subtitleEditInput: document.getElementById('subtitle-edit-input'),
            groupSuggestions: document.getElementById('group-suggestions'),
            memberSuggestions: document.getElementById('member-suggestions'),
            albumSuggestions: document.getElementById('album-suggestions'),
            cardDescriptionInput: document.getElementById('card-description-input'),
            descriptionSuggestions: document.getElementById('description-suggestions'),
            lastUpdatedDisplay: document.getElementById('last-updated-display'),
            countrySuggestions: document.getElementById('country-suggestions'),
            infoSheetContent: document.getElementById('info-sheet-content'),
            infoSheetEditButton: document.getElementById('edit-info-sheet-btn'),
            infoSheetEditTextarea: document.getElementById('info-sheet-edit-textarea'),
            exportValidationMessage: document.getElementById('export-validation-message'),
            totalCardsStat: document.getElementById('total-cards-stat'),
            soldCardsStat: document.getElementById('sold-cards-stat'),
            availableValueStat: document.getElementById('available-value-stat'),
            soldValueStat: document.getElementById('sold-value-stat'),
            openStatsModalBtn: document.getElementById('open-stats-modal-btn'),
            reservedCardsStat: document.getElementById('reserved-cards-stat'),
            onSaleCardsStat: document.getElementById('on-sale-cards-stat'),
            onSuperSaleCardsStat: document.getElementById('on-super-sale-cards-stat'),
            totalDiscountValueStat: document.getElementById('total-discount-value-stat'),
            backToTopBtn: document.getElementById('back-to-top-btn'),
            deselectAllBtn: document.getElementById('deselect-all-btn'),
            disclaimerModal: document.getElementById('disclaimer-modal'),
            disclaimerContent: document.getElementById('disclaimer-content'),
            disclaimerEditTextarea: document.getElementById('disclaimer-edit-textarea'),
            editDisclaimerBtn: document.getElementById('edit-disclaimer-btn'),
        };

        // Utility function to darken a hex color
        function darkenColor(hex, percent) {
            if (!hex || hex.length < 7) return '#000000';
            let R = parseInt(hex.substring(1,3),16);
            let G = parseInt(hex.substring(3,5),16);
            let B = parseInt(hex.substring(5,7),16);

            R = parseInt(R * (100 - percent) / 100);
            G = parseInt(G * (100 - percent) / 100);
            B = parseInt(B * (100 - percent) / 100);

            R = (R<255)?R:255;  
            G = (G<255)?G:255;  
            B = (B<255)?B:255;  

            const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
            const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
            const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

            return "#"+RR+GG+BB;
        }

        function isNewCard(createdAt) {
            if (!createdAt) return false;
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const cardDate = new Date(createdAt);
            return cardDate >= sevenDaysAgo;
        }

        function displayCards() {
            ui.grid.innerHTML = '';
            const searchTerm = ui.searchInput.value.toLowerCase();
            const searchTerms = searchTerm.split(';').map(term => term.trim()).filter(term => term.length > 0);
            const selectedGroup = ui.groupFilter.value;
            const selectedStatus = ui.statusFilter.value;
            const sortMethod = ui.sortOrder.value;

            let cardsToDisplay = allCards.filter(card => {
                if (!isAdmin && card.status === 'sold') {
                    return false;
                }

                const searchCorpus = `${card.member || ''} ${card.group || ''} ${card.album || ''} ${card.displayId || ''}`.toLowerCase();
                const matchesSearch = searchTerms.length === 0 || searchTerms.some(term => searchCorpus.includes(term));
                const matchesGroup = selectedGroup === 'all' || card.group === selectedGroup;
                
                let matchesStatus = true;

                if (selectedStatus !== 'all') {
                    if (selectedStatus === 'new') {
                        matchesStatus = isNewCard(card.createdAt);
                    } else if (selectedStatus === 'sale') {
                        matchesStatus = card.discountType === 'sale';
                    } else if (selectedStatus === 'super-sale') {
                        matchesStatus = card.discountType === 'super-sale';
                    } else {
                        matchesStatus = card.status === selectedStatus;
                    }
                }
                
                return matchesSearch && matchesGroup && matchesStatus;
            });
            
            ui.noResults.classList.toggle('hidden', cardsToDisplay.length > 0);

            switch(sortMethod) {
                case 'price-desc':
                    cardsToDisplay.sort((a, b) => (b.price || 0) - (a.price || 0));
                    break;
                case 'price-asc':
                    cardsToDisplay.sort((a, b) => (a.price || 0) - (b.price || 0));
                    break;
                case 'date-desc':
                    cardsToDisplay.sort((a, b) => (b.createdAt || "0").localeCompare(a.createdAt || "0"));
                    break;
                case 'id-asc':
                    cardsToDisplay.sort((a, b) => (a.displayId || '').localeCompare(b.displayId || ''));
                    break;
                case 'default':
                default:
                    cardsToDisplay.sort((a, b) => {
                        if (currentBias) {
                            const isABias = a.member === currentBias;
                            const isBBias = b.member === currentBias;
                            if (isABias && !isBBias) return -1;
                            if (!isABias && isBBias) return 1;
                        }

                        const groupAIndex = GROUP_ORDER.indexOf(a.group);
                        const groupBIndex = GROUP_ORDER.indexOf(b.group);
                        if (groupAIndex !== groupBIndex) return groupAIndex - groupBIndex;

                        const memberAIndex = MEMBER_ORDER.indexOf(a.member);
                        const memberBIndex = MEMBER_ORDER.indexOf(b.member);
                        if (memberAIndex !== memberBIndex) return memberAIndex - memberBIndex;
                        
                        const albumCompare = (a.album || '').localeCompare(b.album || '');
                        if (albumCompare !== 0) return albumCompare;

                        const priceCompare = (b.price || 0) - (a.price || 0);
                        if (priceCompare !== 0) return priceCompare;

                        return (a.displayId || '').localeCompare(b.displayId || '');
                    });
                    break;
            }

            cardsToDisplay.forEach((card, index) => {
                const cardElement = document.createElement('div');
                const memberKey = card.member ? card.member.toLowerCase() : '';
                const memberColor = MEMBER_COLORS[memberKey] || '#FFFFFF';
                
                // Define gradient for the text area background using member-specific colors
                const gradientStart = memberColor;
                const gradientEnd = darkenColor(memberColor, 15); // Slightly darker for subtle gradient
                const cardTextAreaBackground = `linear-gradient(to bottom, ${gradientStart}, ${gradientEnd})`;


                const isSelected = selectedCards.includes(card.id);
                cardElement.className = `group-item rounded-lg shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all duration-300 fade-in flex flex-col ${isSelected ? 'card-selected' : ''}`;
                cardElement.style.backgroundColor = memberColor; // This sets the overall card background
                cardElement.style.animationDelay = `${index * 50}ms`;
                cardElement.onclick = (e) => {
                    if (e.target.closest('button')) return;
                    toggleCardSelection(card.id);
                };

                let cardOpacity = '';
                if (card.status === 'sold') {
                    cardOpacity = 'opacity-50';
                } else if (card.status === 'on-hold') {
                    cardOpacity = 'opacity-60 grayscale';
                }

                const showCheckbox = !isAdmin ? card.status !== 'sold' : true;
                const selectionCheckbox = `
                    <button onclick="window.toggleCardSelection('${card.id}')" class="absolute top-2 right-2 w-7 h-7 flex items-center justify-center bg-white/50 rounded-full text-indigo-600 hover:bg-white/80 transition z-20">
                        ${isSelected ? 
                            `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" class="text-red-500"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>` : 
                            `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`
                        }
                    </button>
                `;

                let statusBadgesHtml = '';
                if (card.status === 'sold') {
                    statusBadgesHtml += `<span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full tag-sold">SOLD</span>`;
                } else {
                    if (isNewCard(card.createdAt)) {
                        statusBadgesHtml += `<span class="text-xs font-bold px-2 py-1 rounded-full tag-new">NEW</span>`;
                    }
                    if (card.discountType === 'sale') {
                        statusBadgesHtml += `<span class="text-xs font-bold px-2 py-1 rounded-full tag-sale">SALE</span>`;
                    } else if (card.discountType === 'super-sale') {
                        statusBadgesHtml += `<span class="text-xs font-bold px-2 py-1 rounded-full tag-super-sale">SUPER SALE</span>`;
                    }
                    if (card.status === 'on-hold') {
                        statusBadgesHtml += `<span class="text-xs font-bold px-2 py-1 rounded-full tag-reserved">RESERVED</span>`;
                    }
                }
                
                const adminControls = isAdmin ? `
                    <div class="flex flex-col gap-1">
                        <button onclick="window.toggleDiscount('${card.id}', 'sale')" class="p-1 bg-red-500 text-white rounded-full hover:bg-red-600" title="Toggle 10% Sale"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg></button>
                        <button onclick="window.toggleDiscount('${card.id}', 'super-sale')" class="p-1 bg-purple-700 text-white rounded-full hover:bg-purple-800" title="Toggle 20% Super Sale"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg></button>
                        <button onclick="window.openEditModal('${card.id}')" class="p-1 bg-blue-600 text-white rounded-full hover:bg-blue-700" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                        <button onclick="window.toggleStatus('${card.id}', 'sold')" class="p-1 bg-red-600 text-white rounded-full hover:bg-red-700" title="Toggle Sold"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></button>
                        <button onclick="window.toggleStatus('${card.id}', 'on-hold')" class="p-1 bg-yellow-500 text-white rounded-full hover:bg-yellow-600" title="Toggle Reserved"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></button>
                        <button onclick="window.openSingleDeleteModal('${card.id}')" class="p-1 bg-gray-700 text-white rounded-full hover:bg-gray-800" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </div>` : '';

                cardElement.innerHTML = `
                    <div class="relative">
                        <img src="${card.imageUrl || ''}" alt="${card.member || ''} from ${card.group || ''}" class="w-full h-auto object-cover aspect-[2/3] ${cardOpacity}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/cccccc/ffffff?text=No+Image';">
                        <div class="absolute top-2 left-2 bg-black/50 text-xs font-mono px-1.5 py-0.5 rounded" style="color: ${memberColor};">${card.displayId || 'N/A'}</div>
                        ${showCheckbox ? selectionCheckbox : ''}
                        <div class="absolute bottom-2 right-2 flex flex-col items-end gap-1 z-10">
                            ${statusBadgesHtml ? `<div class="flex flex-col items-end gap-1">${statusBadgesHtml}</div>` : ''}
                            ${adminControls}
                        </div>
                    </div>
                    <div class="card-text-area" style="background-image: ${cardTextAreaBackground};">
                        <div>
                            <p class="font-bold text-lg">` + (card.member || 'Unknown') + `</p>
                            <p class="text-sm opacity-80">` + (card.group || 'Unknown') + `</p>
                            <p class="text-sm line-clamp-2 opacity-80 min-height: 2.5rem;" title="` + (card.album || '') + `">` + (card.album || 'Unknown') + `</p>
                            <p class="text-xs mt-1 opacity-70 h-8 overflow-hidden">` + (card.description || '') + `</p>
                        </div>
                        <p class="text-xl font-semibold mt-auto pt-2 flex items-baseline">
                            €` + parseFloat(card.price || 0).toFixed(2) + `
                            ${card.discountType && card.originalPrice !== null && card.originalPrice !== undefined && card.originalPrice > card.price ?
                                `<span class="text-sm line-through opacity-70 ml-2 font-normal">€${parseFloat(card.originalPrice).toFixed(2)}</span>` : ''}
                        </p>
                    </div>`;
                ui.grid.appendChild(cardElement);
            });
        }
        
        function updateGroupFilter() {
            const groups = [...new Set(allCards.map(card => card.group).filter(g => g))];
            groups.sort((a, b) => GROUP_ORDER.indexOf(a) - GROUP_ORDER.indexOf(b));
            ui.groupFilter.innerHTML = '<option value="all">All Groups</option>';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                ui.groupFilter.appendChild(option);
            });
        }

        // Removed the unconditional onSnapshot from global scope.
        // It will now be managed by setAdminMode.

        onSnapshot(settingsDoc, (doc) => {
            const data = doc.exists() ? doc.data() : {};
            ui.mainTitle.textContent = data.title || "Photocard Sale";
            ui.subtitle.textContent = data.subtitle || "Welcome to my collection! Feel free to browse.";
            document.title = ui.mainTitle.textContent;
            if (data.lastUpdated) {
                ui.lastUpdatedDisplay.textContent = `Last updated: ${data.lastUpdated}`;
                ui.lastUpdatedDisplay.classList.remove('hidden');
            } else {
                ui.lastUpdatedDisplay.classList.add('hidden');
            }
        });

        onSnapshot(infoSheetDoc, (doc) => {
            const data = doc.exists() ? doc.data() : {};
            ui.infoSheetContent.innerHTML = data.content || `
                <h4 class="text-lg font-semibold mb-2">How to Buy:</h4>
                <ol class="list-decimal list-inside space-y-1">
                    <li>Browse the available photocards.</li>
                    <li>Select the cards you'd like to purchase by clicking them.</li>
                    <li>Click the shopping cart icon at the bottom right.</li>
                    <li>Fill in your shipping and payment preferences.</li>
                    <li>Copy the generated text and send it to me on Instagram!</li>
                </ol>
                <h4 class="text-lg font-semibold mt-4 mb-2">Payment Methods:</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li>PayPal F&F (Friends & Family) - preferred</li>
                    <li>Wise (formerly TransferWise)</li>
                    <li>Bank Transfer (within EU)</li>
                </ul>
                <h4 class="text-lg font-semibold mt-4 mb-2">Shipping Information:</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li>Shipping costs are not included in the listed prices and will be calculated based on your location and chosen shipping method.</li>
                    <li>Options: Cheapest (untracked), Tracked, Insured.</li>
                    <li>I ship worldwide!</li>
                </ul>
                <h4 class="text-lg font-semibold mt-4 mb-2">Condition:</h4>
                <p>All cards are carefully sleeved and stored in a dry, pet-free, and smoke-free household. While I strive for perfection, please note that some cards may have minor manufacturing defects or small imperfections. If you are highly sensitive to such details, I recommend refraining from purchasing.</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">Contact:</h4>
                <p>For any questions or to finalize a purchase, please message me on <a href="https://www.instagram.com/bananatrades877/" target="_blank" class="text-blue-600 hover:underline">Instagram: @bananatrades877</a></p>
            `;
        });

        onSnapshot(disclaimerDoc, (doc) => {
            const data = doc.exists() ? doc.data() : {};
            ui.disclaimerContent.innerHTML = data.content || `
                <p class="font-semibold text-lg mb-2">A Friendly Note About My Photocard Collection!</p>
                <p class="mb-2">Welcome! This website is a personal space where I lovingly showcase K-Pop photocards from my own collection that are currently available. Think of it less as a traditional shop and more as a way for a fellow collector to browse my offerings easily.</p>
                <p class="mb-2">As a private individual, I'm doing this purely out of passion for collecting, not as a business or for profit. This means all sales are considered private transactions and are final. I won't be able to offer returns, exchanges, or commercial warranties.</p>
                <p class="mb-2">I always strive to keep my cards in excellent condition by carefully sleeving and storing them. I also do my best to describe and photograph each card accurately, but please keep in mind that minor manufacturing imperfections might occasionally be present.</p>
                <p class="mb-2">By continuing to explore my collection, you're kindly acknowledging these terms. If you'd prefer not to proceed, that's perfectly alright, and you can exit the site.</p>
                <p class="text-sm text-gray-500 mt-4">Thank you so much for your understanding and happy Browse!</p>
            `;
        });

        // Firebase Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                setAdminMode(true);
            } else {
                setAdminMode(false);
            }
        });


        function setAdminMode(enabled) {
            isAdmin = enabled;
            ui.adminLoginBtn.classList.toggle('hidden', enabled);
            ui.adminLogoutBtn.classList.toggle('hidden', !enabled);
            ui.addCardBtn.classList.toggle('hidden', !enabled);
            ui.editTitleBtn.classList.toggle('hidden', !enabled);
            ui.editTitleBtn.classList.toggle('admin-visible', enabled);
            ui.editSubtitleBtn.classList.toggle('hidden', !enabled);
            ui.editSubtitleBtn.classList.toggle('admin-visible', enabled);
            ui.infoSheetEditButton.classList.toggle('hidden', !enabled);
            ui.infoSheetEditButton.classList.toggle('admin-visible', enabled);
            ui.openStatsModalBtn.classList.toggle('hidden', !enabled);
            ui.editDisclaimerBtn.classList.toggle('hidden', !enabled); // Show/hide edit disclaimer button
            
            const soldOption = ui.statusFilter.querySelector('option[value="sold"]');
            if (soldOption) {
                soldOption.hidden = !enabled;
            }

            if (!enabled && ui.statusFilter.value === 'sold') {
                ui.statusFilter.value = 'all';
            }

            selectedCards = [];
            updateUiAfterSelection();
            
            // --- Manage Photocard Listener based on Admin Mode ---
            if (unsubscribePhotocards) {
                unsubscribePhotocards(); // Unsubscribe from previous listener
            }

            if (enabled) { // Admin mode: listen to all photocards
                unsubscribePhotocards = onSnapshot(photocardsCollection, (snapshot) => {
                    allCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateGroupFilter();
                    displayCards();
                }, (error) => {
                    console.error("Error fetching photocards (Admin Mode): ", error);
                    showMessageBox('Error', `Failed to load cards (Admin): ${error.message}`);
                });
            } else { // Public mode: listen only to non-sold photocards
                const q = query(photocardsCollection, where("status", "!=", "sold"));
                unsubscribePhotocards = onSnapshot(q, (snapshot) => {
                    allCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateGroupFilter();
                    displayCards();
                }, (error) => {
                    console.error("Error fetching photocards (Public Mode): ", error);
                    showMessageBox('Error', `Failed to load cards: ${error.message}. Ensure public read rules are correct.`);
                });
            }
            // --- End Photocard Listener Management ---
        }

        async function updateLastUpdatedTimestamp() {
            try {
                await setDoc(settingsDoc, { lastUpdated: new Date().toISOString().split('T')[0] }, { merge: true });
            } catch (error) {
                console.error("Error updating timestamp: ", error);
                showMessageBox('Error', `Failed to update timestamp: ${error.message}`);
            }
        }

        window.checkAdminPassword = async () => {
            const email = ui.adminEmailInput.value;
            const password = ui.adminPasswordInput.value;
            ui.adminLoginMessage.classList.add('hidden'); // Hide previous messages

            if (!email || !password) {
                ui.adminLoginMessage.textContent = 'Email and password are required.';
                ui.adminLoginMessage.classList.remove('hidden');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                window.closeModal('admin-login-modal');
                ui.adminEmailInput.value = '';
                ui.adminPasswordInput.value = '';
            } catch (error) {
                console.error("Firebase Auth Error: ", error);
                let errorMessage = 'Login failed. Please check your credentials.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Incorrect email or password.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many login attempts. Please try again later.';
                }
                ui.adminLoginMessage.textContent = errorMessage;
                ui.adminLoginMessage.classList.remove('hidden');
            } finally {
                // No loading spinner to hide
            }
        };

        window.logoutAdmin = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error logging out: ", error);
                showMessageBox('Error', `Failed to log out: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        };

        function showMessageBox(title, message) {
            const modalId = 'custom-message-modal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal-backdrop hidden';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                        <h3 class="text-xl font-bold mb-2" id="message-box-title"></h3>
                        <p class="text-gray-600 mb-6" id="message-box-content"></p>
                        <button onclick="window.closeModal('${modalId}')" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">OK</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            document.getElementById('message-box-title').textContent = title;
            document.getElementById('message-box-content').textContent = message;
            window.openModal(modalId);
        }

        window.openStatsModal = () => {
            const totalCards = allCards.length;
            const soldCards = allCards.filter(card => card.status === 'sold');
            const reservedCards = allCards.filter(card => card.status === 'on-hold');
            const onSaleCards = allCards.filter(card => card.discountType === 'sale');
            const onSuperSaleCards = allCards.filter(card => card.discountType === 'super-sale');
            const availableCards = allCards.filter(card => card.status !== 'sold'); // Used for inventory value

            const soldCardsCount = soldCards.length;
            const reservedCardsCount = reservedCards.length;
            const onSaleCardsCount = onSaleCards.length;
            const onSuperSaleCardsCount = onSuperSaleCards.length;

            const totalAvailableValue = availableCards.reduce((sum, card) => sum + (card.price || 0), 0);
            const totalSoldValue = soldCards.reduce((sum, card) => sum + (card.price || 0), 0);
            
            // Calculate total discount value
            const totalDiscountValue = allCards.reduce((sum, card) => {
                if (card.discountType && card.originalPrice) {
                    return sum + (card.originalPrice - card.price);
                }
                return sum;
            }, 0);


            ui.totalCardsStat.textContent = totalCards;
            ui.soldCardsStat.textContent = soldCardsCount;
            ui.reservedCardsStat.textContent = reservedCardsCount;
            ui.onSaleCardsStat.textContent = onSaleCardsCount;
            ui.onSuperSaleCardsStat.textContent = onSuperSaleCardsCount;
            ui.availableValueStat.textContent = `€${totalAvailableValue.toFixed(2)}`;
            ui.soldValueStat.textContent = `€${totalSoldValue.toFixed(2)}`;
            ui.totalDiscountValueStat.textContent = `€${totalDiscountValue.toFixed(2)}`;

            window.openModal('stats-modal');
        };

        async function updateDisplayIdField() {
            const cardId = document.getElementById('card-id-input').value;
            if (cardId) return;
            
            const group = ui.cardGroupInput.value;
            const member = ui.cardMemberInput.value;
            if (group && member) {
                document.getElementById('card-display-id-input').value = await generateDisplayId(group, member);
            }
        }

        window.openAddCardModal = () => {
            ui.addCardForm.reset();
            ui.modalTitle.textContent = 'Add a New Card';
            document.getElementById('card-id-input').value = '';
            const existingDescriptions = [...new Set(allCards.map(c => c.description).filter(d => d))];
            setupAutocomplete(ui.cardDescriptionInput, ui.descriptionSuggestions, existingDescriptions, null);
            window.openModal('add-card-modal');
            updateDisplayIdField();
        };
        
        window.openEditModal = (cardId) => {
            const card = allCards.find(c => c.id === cardId);
            if (!card) return;
            ui.addCardForm.reset();
            ui.modalTitle.textContent = 'Edit Card';
            document.getElementById('card-id-input').value = card.id;
            document.getElementById('card-display-id-input').value = card.displayId;
            document.getElementById('card-group-input').value = card.group;
            document.getElementById('card-member-input').value = card.member;
            document.getElementById('card-album-input').value = card.album;
            document.getElementById('card-image-url-input').value = card.imageUrl;
            document.getElementById('card-description-input').value = card.description;
            document.getElementById('card-price-input').value = card.price;
            const existingDescriptions = [...new Set(allCards.map(c => c.description).filter(d => d))];
            setupAutocomplete(ui.cardDescriptionInput, ui.descriptionSuggestions, existingDescriptions, null);
            window.openModal('add-card-modal');
        };

        async function generateDisplayId(group, member) {
            const groupCode = GROUP_ABBR[group] || group.substring(0,2).toUpperCase();
            const memberCode = member.charAt(0).toUpperCase();
            
            const q = query(photocardsCollection, where("group", "==", group), where("member", "==", member));
            const querySnapshot = await getDocs(q);
            const newNumber = String(querySnapshot.size + 1).padStart(3, '0');
            
            return `${groupCode}-${memberCode}-${newNumber}`;
        }
        
        async function handleSave(closeOnFinish) {
            const cardId = document.getElementById('card-id-input').value;
            const cardData = {
                displayId: document.getElementById('card-display-id-input').value,
                group: document.getElementById('card-group-input').value,
                member: document.getElementById('card-member-input').value,
                album: document.getElementById('card-album-input').value,
                imageUrl: document.getElementById('card-image-url-input').value,
                description: document.getElementById('card-description-input').value,
                price: parseFloat(document.getElementById('card-price-input').value),
            };

            if (cardId) {
                const oldCard = allCards.find(c => c.id === cardId);
                if (oldCard && oldCard.price !== cardData.price) {
                    cardData.discountType = null;
                    cardData.originalPrice = null;
                }
            }

            try {
                if (cardId) {
                    const cardRef = doc(db, "photocards", cardId);
                    await updateDoc(cardRef, cardData);
                } else {
                    cardData.status = 'available';
                    cardData.createdAt = new Date().toISOString();
                    if (!cardData.displayId) {
                         cardData.displayId = await generateDisplayId(cardData.group, cardData.member);
                    }
                    await addDoc(photocardsCollection, cardData);
                }
                
                await updateLastUpdatedTimestamp();

                if (closeOnFinish) {
                    window.closeModal('add-card-modal');
                } else {
                    const savedGroup = cardData.group;
                    const savedMember = cardData.member;
                    ui.addCardForm.reset();
                    document.getElementById('card-group-input').value = savedGroup;
                    document.getElementById('card-member-input').value = savedMember;
                    await updateDisplayIdField();
                    const confirmMsg = document.getElementById('save-another-confirm');
                    confirmMsg.style.opacity = 1;
                    setTimeout(() => { confirmMsg.style.opacity = 0; }, 2000);
                }
            } catch (error) {
                console.error("Error saving card: ", error);
                showMessageBox('Error', `Failed to save card: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        }

        ui.addCardForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSave(true);
        });
        
        window.saveAndAddAnother = () => handleSave(false);

        window.toggleStatus = async (cardId, targetStatus) => {
            const cardRef = doc(db, "photocards", cardId);
            const cardDoc = await getDoc(cardRef);
            if (!cardDoc.exists()) return;
            const currentStatus = cardDoc.data().status;
            const newStatus = currentStatus === targetStatus ? 'available' : targetStatus;
            
            try {
                await updateDoc(cardRef, { status: newStatus });
                await updateLastUpdatedTimestamp();
            } catch (error) {
                console.error("Error toggling status: ", error);
                showMessageBox('Error', `Failed to toggle status: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        };
        
        window.openSingleDeleteModal = (cardId) => {
            window.openModal('delete-confirm-modal');
            ui.deleteConfirmBtn.onclick = () => deleteCard(cardId);
        };
        
        async function deleteCard(cardId) {
            try {
                await deleteDoc(doc(db, "photocards", cardId));
                await updateLastUpdatedTimestamp();
                window.closeModal('delete-confirm-modal');
            } catch (error) {
                console.error("Error deleting card: ", error);
                showMessageBox('Error', `Failed to delete card: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        }

        window.openTitleEditModal = () => {
            ui.titleEditInput.value = ui.mainTitle.textContent;
            window.openModal('title-edit-modal');
        };

        window.saveTitle = async () => {
            const newTitle = ui.titleEditInput.value;
            if (newTitle && newTitle.trim() !== "") {
                try {
                    await setDoc(settingsDoc, { title: newTitle.trim() }, { merge: true });
                    await updateLastUpdatedTimestamp();
                    window.closeModal('title-edit-modal');
                } catch (error) {
                    console.error("Error saving title: ", error);
                    showMessageBox('Error', `Failed to save title: ${error.message}`);
                }
            }
        };

        window.openSubtitleEditModal = () => {
            ui.subtitleEditInput.value = ui.subtitle.textContent;
            window.openModal('subtitle-edit-modal');
        };

        window.saveSubtitle = async () => {
            const newSubtitle = ui.subtitleEditInput.value;
            if (newSubtitle && newSubtitle.trim() !== "") {
                try {
                    await setDoc(settingsDoc, { subtitle: newSubtitle.trim() }, { merge: true });
                    await updateLastUpdatedTimestamp();
                    window.closeModal('subtitle-edit-modal');
                } catch (error) {
                    console.error("Error saving subtitle: ", error);
                    showMessageBox('Error', `Failed to save subtitle: ${error.message}`);
                } finally {
                    // No loading spinner to hide
                }
            }
        };

        window.openInfoSheetModal = () => {
            window.openModal('info-sheet-modal');
        };

        window.openInfoSheetEditModal = async () => {
            try {
                const docSnap = await getDoc(infoSheetDoc);
                ui.infoSheetEditTextarea.value = docSnap.exists() ? docSnap.data().content : '';
                window.openModal('info-sheet-edit-modal');
            } catch (error) {
                console.error("Error opening info sheet edit modal: ", error);
                showMessageBox('Error', `Failed to load info sheet for editing: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        };

        window.saveInfoSheetContent = async () => {
            const newContent = ui.infoSheetEditTextarea.value;
            try {
                await setDoc(infoSheetDoc, { content: newContent.trim() }, { merge: true });
                await updateLastUpdatedTimestamp();
                window.closeModal('info-sheet-edit-modal');
            } catch (error) {
                console.error("Error saving info sheet content: ", error);
                showMessageBox('Error', `Failed to save info sheet: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        };

        // New Disclaimer functions
        window.openDisclaimerEditModal = async () => {
            try {
                const docSnap = await getDoc(disclaimerDoc);
                // Create a temporary div to convert HTML to plain text
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = ui.disclaimerContent.innerHTML;

                // Populate with Firebase content if it exists and is not empty, otherwise use the currently displayed content's text
                ui.disclaimerEditTextarea.value = (docSnap.exists() && docSnap.data().content) ? docSnap.data().content : tempDiv.textContent.trim();
                window.openModal('disclaimer-edit-modal');
            } catch (error) {
                console.error("Error opening disclaimer edit modal: ", error);
                showMessageBox('Error', `Failed to load disclaimer for editing: ${error.message}`);
            }
        };

        window.saveDisclaimerContent = async () => {
            const newContent = ui.disclaimerEditTextarea.value;
            try {
                await setDoc(disclaimerDoc, { content: newContent.trim() }, { merge: true });
                await updateLastUpdatedTimestamp();
                window.closeModal('disclaimer-edit-modal');
            } catch (error) {
                console.error("Error saving disclaimer content: ", error);
                showMessageBox('Error', `Failed to save disclaimer: ${error.message}`);
            }
        };

        window.acceptDisclaimer = () => {
            localStorage.setItem('disclaimerAccepted', 'true');
            window.closeModal('disclaimer-modal');
            // Re-initialize site after acceptance
            initApp(); 
        };

        window.declineDisclaimer = () => {
            window.location.href = "https://www.google.com"; // Redirect if declined
        };
        // End New Disclaimer functions


        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            if (id === 'admin-login-modal') {
                setTimeout(() => ui.adminEmailInput.focus(), 50);
            }
        };
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
        };

        window.toggleCardSelection = (cardId) => {
            const cardIndex = selectedCards.indexOf(cardId);
            if (cardIndex > -1) {
                selectedCards.splice(cardIndex, 1);
            } else {
                selectedCards.push(cardId);
            }
            displayCards();
            updateUiAfterSelection();
        }
        
        function updateUiAfterSelection() {
            if (isAdmin) {
                updateBulkActionBar();
            } else {
                updateCartButton();
            }
            // Show/hide deselect all button based on selection count
            if (selectedCards.length > 0) {
                ui.deselectAllBtn.classList.add('show');
            } else {
                ui.deselectAllBtn.classList.remove('show');
            }
        }

        function updateCartButton() {
            const count = selectedCards.length;
            ui.cartButton.classList.toggle('hidden', count === 0);
            ui.cartCount.textContent = count;
        }

        function updateBulkActionBar() {
            const count = selectedCards.length;
            if (isAdmin && count > 0) {
                ui.bulkActionBar.classList.remove('hidden');
                ui.addCardBtn.classList.add('hidden');
                ui.bulkCount.textContent = count;
            } else {
                ui.bulkActionBar.classList.add('hidden');
                if (isAdmin) {
                    ui.addCardBtn.classList.remove('hidden');
                }
            }
        }
        
        window.deselectAll = () => {
            selectedCards = [];
            displayCards();
            updateUiAfterSelection();
        };

        window.bulkUpdateStatus = async (status) => {
            if (selectedCards.length === 0) return;
            const batch = writeBatch(db);
            selectedCards.forEach(id => {
                const cardRef = doc(db, "photocards", id);
                batch.update(cardRef, { status: status });
            });
            try {
                await batch.commit();
                await updateLastUpdatedTimestamp();
                window.deselectAll();
            }
            catch (error) {
                console.error("Error bulk updating status: ", error);
                showMessageBox('Error', `Failed to bulk update status: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        };

        window.openBulkPriceModal = () => {
            if (selectedCards.length === 0) return;
            ui.bulkPriceInput.value = '';
            window.openModal('bulk-price-modal');
        };

        window.bulkUpdatePrice = async () => {
            const newPrice = parseFloat(ui.bulkPriceInput.value);
            if (isNaN(newPrice) || newPrice < 0) {
                showMessageBox("Error", "Please enter a valid price.");
                return;
            }
            const batch = writeBatch(db);
            selectedCards.forEach(id => {
                const cardRef = doc(db, "photocards", id);
                batch.update(cardRef, { price: newPrice, discountType: null, originalPrice: null });
            });
            try {
                await batch.commit();
                await updateLastUpdatedTimestamp();
                window.closeModal('bulk-price-modal');
                window.deselectAll();
            } catch (error) {
                console.error("Error bulk updating price: ", error);
                showMessageBox('Error', `Failed to bulk update price: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        };

        window.openBulkDeleteModal = () => {
            if (selectedCards.length === 0) return;
            window.openModal('delete-confirm-modal');
            ui.deleteConfirmBtn.onclick = () => bulkDelete();
        };

        async function bulkDelete() {
            const batch = writeBatch(db);
            selectedCards.forEach(id => {
                const cardRef = doc(db, "photocards", id);
                batch.delete(cardRef);
            });
            try {
                await batch.commit();
                await updateLastUpdatedTimestamp();
                window.closeModal('delete-confirm-modal');
                window.deselectAll();
            } catch (error) {
                console.error("Error bulk deleting: ", error);
                showMessageBox('Error', `Failed to bulk delete: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        };

        function calculateDiscountedPrice(originalPrice, type) {
            const minFinalPrice = 1.00; // Global minimum price
            let percentage;
            let minDiscountAmount;

            if (type === 'sale') {
                percentage = 0.10;
                minDiscountAmount = 0.50;
            } else if (type === 'super-sale') {
                percentage = 0.20;
                minDiscountAmount = 1.00; // New minimum for 20% discount
            } else {
                return originalPrice; // Should not happen if 'type' is always 'sale' or 'super-sale'
            }

            let calculatedDiscountAmount = originalPrice * percentage;

            // Apply minimum discount
            let finalDiscountAmount = Math.max(calculatedDiscountAmount, minDiscountAmount);

            let newPrice = originalPrice - finalDiscountAmount;

            // Ensure price doesn't drop below minFinalPrice
            newPrice = Math.max(newPrice, minFinalPrice);

            // Round up to the nearest 0.50
            return Math.ceil(newPrice * 2) / 2;
        }

        window.toggleDiscount = async (cardId, type) => {
            const cardRef = doc(db, "photocards", cardId);
            const cardDoc = await getDoc(cardRef);
            if (!cardDoc.exists()) return;

            const cardData = cardDoc.data();
            const originalPrice = cardData.originalPrice || cardData.price;
            
            try {
                if (cardData.discountType === type) {
                    await updateDoc(cardRef, {
                        price: originalPrice,
                        discountType: null,
                        originalPrice: null
                    });
                } else {
                    const newPrice = calculateDiscountedPrice(originalPrice, type);
                    await updateDoc(cardRef, {
                        price: newPrice,
                        discountType: type,
                        originalPrice: originalPrice
                    });
                }
                await updateLastUpdatedTimestamp();
            } catch (error) {
                console.error("Error toggling discount: ", error);
                showMessageBox('Error', `Failed to toggle discount: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        };
        
        window.bulkToggleDiscount = async (type) => {
            if (selectedCards.length === 0) return;
            const batch = writeBatch(db);
            
            for (const id of selectedCards) {
                const cardRef = doc(db, "photocards", id);
                const cardDoc = await getDoc(cardRef);
                if (cardDoc.exists()) {
                    const cardData = cardDoc.data();
                    const originalPrice = cardData.originalPrice || cardData.price;

                    if (cardData.discountType === type) {
                        batch.update(cardRef, { price: originalPrice, discountType: null, originalPrice: null });
                    } else {
                        const newPrice = calculateDiscountedPrice(originalPrice, type);
                        batch.update(cardRef, { price: newPrice, discountType: type, originalPrice: originalPrice });
                    }
                }
            }
            try {
                await batch.commit();
                await updateLastUpdatedTimestamp();
                window.deselectAll();
            } catch (error) {
                console.error("Error bulk toggling discount: ", error);
                showMessageBox('Error', `Failed to bulk toggle discount: ${error.message}`);
            } finally {
                // No loading spinner to hide
            }
        };


        window.openExportModal = () => {
            generateExportText();
            window.openModal('export-modal');
        };

        function generateExportText() {
            const items = selectedCards.map(id => allCards.find(c => c.id === id)).filter(c => c);
            if (items.length === 0) {
                ui.exportTextarea.value = "No cards selected.";
                ui.copyExportBtn.classList.add('opacity-50', 'pointer-events-none');
                ui.exportValidationMessage.classList.remove('hidden');
                ui.exportValidationMessage.textContent = "No cards selected for export.";
                return;
            }

            const countryFilled = ui.exportCountry.value.trim() !== '';

            if (!countryFilled) {
                ui.copyExportBtn.classList.add('opacity-50', 'pointer-events-none');
                ui.exportValidationMessage.classList.remove('hidden');
                ui.exportValidationMessage.classList.add('text-red-500');
                ui.exportValidationMessage.textContent = "Please fill in 'Ship to Country'.";
            } else {
                ui.copyExportBtn.classList.remove('opacity-50', 'pointer-events-none');
                ui.exportValidationMessage.classList.add('hidden');
                ui.exportValidationMessage.textContent = "";
            }


            let message = "Hello! I would like to buy the following card(s):\n\n";
            let totalPrice = 0;

            items.forEach(item => {
                message += `------------------------------\n`;
                message += `${item.displayId}\n`;
                message += `${item.member} (${item.group}) - ${item.album}\n`;
                if (item.description) {
                    message += `${item.description}\n`;
                }
                
                let priceLine = `€${(item.price || 0).toFixed(2)}`;
                if (item.discountType === 'sale') {
                    priceLine += ' (SALE)';
                } else if (item.discountType === 'super-sale') {
                    priceLine += ' (SUPER SALE)';
                }
                message += `${priceLine}\n`;
                totalPrice += item.price || 0;
            });

            message += `------------------------------\n\n`;
            message += `TOTAL (${items.length} cards): €${totalPrice.toFixed(2)} (excl. shipping)\n\n`;
            message += `--- Shipping & Payment ---\n`;
            message += `Ship to: ${ui.exportCountry.value || 'Please specify'}\n`;
            message += `Shipping Method: ${ui.exportShipping.value}\n`;
            message += `Payment Method: ${ui.exportPayment.value}\n`;

            ui.exportTextarea.value = message;
        }
        
        window.copyExportText = () => {
            if (ui.exportCountry.value.trim() === '') {
                ui.exportValidationMessage.classList.remove('hidden');
                ui.exportValidationMessage.classList.add('text-red-500');
                ui.exportValidationMessage.textContent = "Please fill in 'Ship to Country' to copy.";
                return;
            }

            ui.exportTextarea.select();
            document.execCommand('copy');
            ui.copyExportBtn.textContent = 'Copied!';
            setTimeout(() => { ui.copyExportBtn.textContent = 'Copy Text'; }, 2000);
        };

        function applyTheme(name) {
            const theme = THEMES[name] || THEMES['Red Velvet'];
            currentBias = name === 'Red Velvet' ? null : name;
            const root = document.documentElement;
            root.style.setProperty('--color-primary', theme.primary);
            root.style.setProperty('--color-secondary', theme.secondary);
            localStorage.setItem('selectedTheme', name);

            ui.controlPanel.classList.add('theme-bg-gradient');
            ui.mainTitle.classList.add('theme-text');
            ui.subtitle.classList.add('theme-text');

            document.querySelectorAll('#theme-switcher button').forEach(btn => {
                if (btn.dataset.themeName === name) {
                    btn.classList.add('ring-2', 'ring-offset-2', 'theme-ring-focus');
                    btn.style.borderColor = theme.primary;
                    btn.classList.remove('opacity-70');
                } else {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'theme-ring-focus');
                    btn.classList.add('opacity-70');
                }
            });
            displayCards();
        }

        function initThemes() {
            Object.entries(THEMES).forEach(([name, theme]) => {
                const bubble = document.createElement('button');
                bubble.className = `w-10 h-10 rounded-full flex items-center justify-center font-bold text-white text-xl shadow-md transition-all hover:opacity-100`;
                bubble.style.backgroundImage = `linear-gradient(to right, ${theme.primary}, ${theme.secondary})`;
                bubble.textContent = theme.initial;
                bubble.dataset.themeName = name;
                bubble.onclick = () => applyTheme(name);
                ui.themeSwitcher.appendChild(bubble);
            });

            const savedTheme = localStorage.getItem('selectedTheme') || 'Red Velvet';
            applyTheme(savedTheme);
        }

        function setupAutocomplete(inputElement, suggestionsElement, sourceArray, moveToNextConfig) {
            let currentFocus = -1;

            const closeAllLists = () => {
                if(suggestionsElement) {
                    suggestionsElement.innerHTML = '';
                    suggestionsElement.classList.add('hidden');
                }
            };

            inputElement.addEventListener('input', function() {
                const value = this.value;
                closeAllLists();
                if (!value) return false;
                currentFocus = -1;
                
                const filtered = sourceArray.filter(item => item.toLowerCase().includes(value.toLowerCase()));
                if (filtered.length > 0) {
                    suggestionsElement.classList.remove('hidden');
                    filtered.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item;
                        div.className = 'suggestion-item';
                        div.addEventListener('click', function() {
                            inputElement.value = this.textContent;
                            closeAllLists();
                            inputElement.dispatchEvent(new Event('blur'));
                        });
                        suggestionsElement.appendChild(div);
                    });
                }
            });

            inputElement.addEventListener('keydown', function(e) {
                let items = suggestionsElement.getElementsByTagName('div');
                if (items.length === 0) return;

                if (e.keyCode === 40) { // Arrow DOWN
                    currentFocus++;
                    addActive(items);
                } else if (e.keyCode === 38) { // Arrow UP
                    currentFocus--;
                    addActive(items);
                } else if (e.keyCode === 13) { // Enter
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (items) items[currentFocus].click();
                    } else if (items.length === 1 && moveToNextConfig && moveToNextConfig.nextFieldId) { 
                        items[0].click();
                        const nextField = document.getElementById(moveToNextConfig.nextFieldId); 
                        if(nextField) nextField.focus();
                    }
                }
            });

            function addActive(items) {
                if (!items) return false;
                removeActive(items);
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (items.length - 1);
                items[currentFocus].classList.add("suggestion-active");
            }

            function removeActive(items) {
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.remove("suggestion-active");
                }
            }
        }
        
        function updateMemberAlbumSuggestions() {
            const groupName = ui.cardGroupInput.value;
            const groupData = ARTIST_DATA[groupName];

            if (groupData) {
                setupAutocomplete(ui.cardMemberInput, ui.memberSuggestions, groupData.members, { nextFieldId: 'card-album-input' });
                setupAutocomplete(ui.cardAlbumInput, ui.albumSuggestions, groupData.albums, { nextFieldId: 'card-description-input' });
            } else {
                setupAutocomplete(ui.cardMemberInput, ui.memberSuggestions, [], null);
                setupAutocomplete(ui.cardAlbumInput, ui.albumSuggestions, [], null);
            }
        }

        ui.adminPasswordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') window.checkAdminPassword();
        });
        
        ui.cardGroupInput.addEventListener('blur', updateMemberAlbumSuggestions);
        ui.cardMemberInput.addEventListener('blur', updateDisplayIdField);

        ui.searchInput.addEventListener('input', displayCards);
        ui.groupFilter.addEventListener('change', displayCards);
        ui.statusFilter.addEventListener('change', displayCards);
        ui.sortOrder.addEventListener('change', displayCards);
        
        ui.exportShipping.addEventListener('change', generateExportText);
        ui.exportCountry.addEventListener('input', generateExportText);
        ui.exportPayment.addEventListener('change', generateExportText);
        
        // Main initialization function
        async function initApp() {
            initThemes();
            setupAutocomplete(ui.cardGroupInput, ui.groupSuggestions, Object.keys(ARTIST_DATA), { nextFieldId: 'card-member-input' });
            setupAutocomplete(ui.exportCountry, ui.countrySuggestions, COUNTRY_LIST, null);
            
            ui.addCardBtn.addEventListener('click', () => {
                const existingDescriptions = [...new Set(allCards.map(c => c.description).filter(d => d))];
                setupAutocomplete(ui.cardDescriptionInput, ui.descriptionSuggestions, existingDescriptions, null);
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-container')) {
                    ui.groupSuggestions.classList.add('hidden');
                    ui.memberSuggestions.classList.add('hidden');
                    ui.albumSuggestions.classList.add('hidden');
                    ui.descriptionSuggestions.classList.add('hidden');
                    ui.countrySuggestions.classList.add('hidden');
                }
            });

            // Back to Top button logic
            window.addEventListener('scroll', () => {
                if (window.scrollY > 200) { // Show button after scrolling 200px
                    ui.backToTopBtn.classList.add('show');
                } else {
                    ui.backToTopBtn.classList.remove('show');
                }
            });
        }


        // Check disclaimer status on initial load
        document.addEventListener('DOMContentLoaded', async () => {
            const disclaimerAccepted = localStorage.getItem('disclaimerAccepted');
            if (disclaimerAccepted === 'true') {
                initApp(); // Proceed with normal app initialization
            } else {
                // Fetch disclaimer content and show modal
                const docSnap = await getDoc(disclaimerDoc);
                ui.disclaimerContent.innerHTML = docSnap.exists() ? docSnap.data().content : ui.disclaimerContent.innerHTML; // Fallback to default if no content in DB
                ui.disclaimerModal.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
